#!/usr/bin/env bash

# Help System Constants and Schema
# Part of the dotfiles management system

# --- Help System Version ---
export DOTFILES_HELP_VERSION="1.0.0"

# --- Directories ---
export DOTFILES_HELP_DIR="$DOTFILES_ROOT/helpers/help"
export DOTFILES_HELP_DOCS="$DOTFILES_ROOT/docs/help"
export DOTFILES_HELP_MANIFEST="$DOTFILES_UTILS/help_manifest.json"
export DOTFILES_HELP_CACHE="$DOTFILES_UTILS/.help_cache"

# --- Categories ---
declare -A HELP_CATEGORIES=(
    ["aliases"]="üìã Aliases & Shortcuts"
    ["commands"]="‚ö° Dotfiles Commands" 
    ["scripts"]="üîß Utility Scripts"
    ["tools"]="üõ†Ô∏è  External Tools"
    ["workflows"]="üåä Common Workflows"
    ["references"]="üìö Quick References"
    ["system"]="üíª System Integration"
    ["development"]="‚öôÔ∏è  Development Tools"
)

# --- Help Entry Schema (JSON) ---
# Used for validation and documentation
read -r -d '' HELP_ENTRY_SCHEMA << 'EOF'
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Dotfiles Help Entry",
  "type": "object",
  "required": ["id", "title", "category", "synopsis"],
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique identifier (kebab-case)",
      "pattern": "^[a-z0-9-]+$"
    },
    "title": {
      "type": "string",
      "description": "Display name/title"
    },
    "category": {
      "type": "string",
      "enum": ["aliases", "commands", "scripts", "tools", "workflows", "references", "system", "development"]
    },
    "tags": {
      "type": "array",
      "items": {"type": "string"},
      "description": "Searchable keywords"
    },
    "synopsis": {
      "type": "string",
      "description": "One-line description"
    },
    "usage": {
      "type": "string",
      "description": "Usage pattern/syntax"
    },
    "examples": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "description": {"type": "string"},
          "command": {"type": "string"}
        }
      }
    },
    "seeAlso": {
      "type": "array",
      "items": {"type": "string"},
      "description": "Related help entry IDs"
    },
    "sourcePath": {
      "type": "string",
      "description": "Path to source file"
    },
    "autogenerated": {
      "type": "boolean",
      "description": "Whether this entry was auto-generated"
    },
    "lastModified": {
      "type": "string",
      "format": "date-time"
    },
    "icon": {
      "type": "string",
      "description": "Unicode emoji/icon for display"
    },
    "priority": {
      "type": "integer",
      "minimum": 0,
      "maximum": 100,
      "description": "Display priority (higher = more prominent)"
    }
  }
}
EOF

export HELP_ENTRY_SCHEMA

# --- UI Constants ---
export HELP_UI_WIDTH_MIN=80
export HELP_UI_WIDTH_MAX=120
export HELP_UI_HEIGHT_MIN=24

# --- Search Configuration ---
export HELP_SEARCH_LIMIT=50
export HELP_FUZZY_THRESHOLD=0.6

# --- Color Themes ---
declare -A HELP_THEME_ICONS=(
    ["category"]="üìÇ"
    ["alias"]="‚ö°"
    ["command"]="üîß"
    ["script"]="üìú"
    ["tool"]="üõ†Ô∏è"
    ["workflow"]="üåä"
    ["reference"]="üìñ"
    ["search"]="üîç"
    ["back"]="‚¨ÖÔ∏è"
    ["home"]="üè†"
    ["quit"]="‚ùå"
    ["help"]="‚ùì"
    ["star"]="‚≠ê"
    ["tag"]="üè∑Ô∏è"
)

# --- Keyboard Shortcuts ---
declare -A HELP_SHORTCUTS=(
    ["search"]="/"
    ["back"]="b"
    ["home"]="h"
    ["quit"]="q"
    ["help"]="?"
    ["reload"]="r"
    ["toggle_raw"]="t"
    ["favorites"]="f"
    ["export"]="e"
)

# --- Auto-discovery patterns ---
declare -A HELP_DISCOVERY_PATTERNS=(
    ["aliases"]="*.aliases"
    ["scripts"]="bin/*"
    ["modules"]="modules/*/README*"
    ["docs"]="docs/**/*.md"
)

# --- Default priorities by category ---
declare -A HELP_DEFAULT_PRIORITIES=(
    ["aliases"]=80
    ["commands"]=90
    ["scripts"]=70
    ["tools"]=60
    ["workflows"]=85
    ["references"]=50
    ["system"]=40
    ["development"]=65
)

# Export arrays for use in other modules
export HELP_CATEGORIES
export HELP_THEME_ICONS  
export HELP_SHORTCUTS
export HELP_DISCOVERY_PATTERNS
export HELP_DEFAULT_PRIORITIES

# --- Helper Functions ---
function help.get_category_icon() {
    local category="$1"
    echo "${HELP_CATEGORIES[$category]%%' '*}" || echo "üìÇ"
}

function help.get_theme_icon() {
    local type="$1"
    echo "${HELP_THEME_ICONS[$type]}" || echo "‚Ä¢"
}

function help.validate_category() {
    local category="$1"
    [[ -n "${HELP_CATEGORIES[$category]:-}" ]]
}

function help.ensure_directories() {
    # Only create directories if DOTFILES_ROOT is set
    if [[ -n "${DOTFILES_ROOT:-}" ]]; then
        mkdir -p "$DOTFILES_HELP_DIR" "$DOTFILES_HELP_DOCS" "$(dirname "$DOTFILES_HELP_MANIFEST")" 2>/dev/null || true
    fi
}

function help.get_manifest_age() {
    if [[ -f "$DOTFILES_HELP_MANIFEST" ]]; then
        echo $(($(date +%s) - $(stat -c %Y "$DOTFILES_HELP_MANIFEST" 2>/dev/null || echo 0)))
    else
        echo 999999  # Very old if doesn't exist
    fi
}

# Load helper constants on source only if DOTFILES_ROOT is available
if [[ -n "${DOTFILES_ROOT:-}" ]]; then
    help.ensure_directories
fi
