#!/usr/bin/env bash

source "${HOME}/.config/dotfiles/core/_env"
source "${HOME}/.config/dotfiles/core/_colors"
source "${HOME}/.config/dotfiles/core/_safety"

function dotfiles_version() {
    echo.header "Dotfiles v${DOTFILES_VERSION}"
    echo
    echo "  Path: $DOTFILES_ROOT"
    echo "  Shell: $DOTFILES_SHELL"
    echo "  OS: $DOTFILES_OS ($DOTFILES_ARCH)"
    echo
    echo "Components:"
    echo "  • $(ls $DOTFILES_MODULES/enabled 2>/dev/null | wc -l) enabled modules"
    echo "  • $(ls $DOTFILES_MODULES/disabled 2>/dev/null | wc -l) disabled modules"
    echo "  • $(ls $DOTFILES_BIN 2>/dev/null | wc -l) commands"
    echo "  • $(jq 'length' $DOTFILES_LINKS_DB 2>/dev/null || echo 0) symlinks"
    echo "  • $(jq 'length' $DOTFILES_ENV_DB 2>/dev/null || echo 0) env variables"
}

function dotfiles_reload() {
    echo.info "Reloading shell..."
    exec ${SHELL}
}

function dotfiles_update() {
    echo.header "Updating Dotfiles"
    
    cd "$DOTFILES_ROOT" || exit 1
    
    echo.info "Fetching updates..."
    git fetch origin
    
    local LOCAL=$(git rev-parse @)
    local REMOTE=$(git rev-parse @{u})
    
    if [[ "$LOCAL" == "$REMOTE" ]]; then
        echo.success "Already up to date"
    else
        echo.info "Updates available"
        git pull origin main
        echo.success "Updated successfully"
        dotfiles_reload
    fi
}

function dotfiles_doctor() {
    echo.header "Dotfiles Health Check"
    
    local issues=0
    
    # Check core files
    echo.info "Checking core files..."
    for file in cfg core/_env core/_colors core/_safety core/_bootstrap; do
        if [[ ! -f "$DOTFILES_ROOT/$file" ]]; then
            echo.error "  ✗ Missing: $file"
            ((issues++))
        else
            echo.success "  ✓ $file"
        fi
    done
    
    # Check directories
    echo.info "Checking directories..."
    for dir in bin modules utils configs templates logs; do
        if [[ ! -d "$DOTFILES_ROOT/$dir" ]]; then
            echo.warning "  ✗ Missing directory: $dir"
            mkdir -p "$DOTFILES_ROOT/$dir"
            echo.success "    Created: $dir"
        else
            echo.success "  ✓ $dir"
        fi
    done
    
    # Check symlinks
    echo.info "Checking symlinks..."
    local broken=0
    jq -r 'to_entries | .[] | "\(.key)"' "$DOTFILES_LINKS_DB" 2>/dev/null | \
    while read -r target; do
        if [[ ! -e "$target" ]]; then
            echo.warning "  ✗ Broken link: $target"
            ((broken++))
        fi
    done
    
    if [[ $broken -gt 0 ]]; then
        echo.warning "  Found $broken broken symlinks. Run: dotfiles-link fix"
        ((issues++))
    else
        echo.success "  ✓ All symlinks valid"
    fi
    
    # Check commands
    echo.info "Checking commands..."
    for cmd in jq git curl; do
        if command -v $cmd &>/dev/null; then
            echo.success "  ✓ $cmd"
        else
            echo.warning "  ✗ $cmd not found"
            ((issues++))
        fi
    done
    
    echo
    if [[ $issues -eq 0 ]]; then
        echo.success "No issues found!"
    else
        echo.warning "Found $issues issue(s)"
    fi
}


function dotfiles_install() {
    echo.header "Installing Dotfiles"
    
    # Create symlink to shell rc
    if [[ "$DOTFILES_SHELL" == "bash" ]]; then
        safe_link "$DOTFILES_ROOT/cfg" "$HOME/.bashrc"
    elif [[ "$DOTFILES_SHELL" == "zsh" ]]; then
        safe_link "$DOTFILES_ROOT/cfg" "$HOME/.zshrc"
    fi
    
    # Add bin to path in profile
    if ! grep -q "DOTFILES_ROOT" "$HOME/.profile" 2>/dev/null; then
        echo 'export PATH="$HOME/.config/dotfiles/bin:$PATH"' >> "$HOME/.profile"
    fi
    
    echo.success "Dotfiles installed"
    echo.info "Restart your shell or run: source ~/.${DOTFILES_SHELL}rc"
}

function dotfiles_modules() {
    echo.header "Module Manager"
    
    case "${2:-list}" in
        list|ls)
            echo.cyan "Enabled modules:"
            for file in "$DOTFILES_MODULES/enabled"/*; do
                [[ -f "$file" ]] && echo "  • $(basename "$file")"
            done
            
            echo.cyan "Disabled modules:"
            for file in "$DOTFILES_MODULES/disabled"/*; do
                [[ -f "$file" ]] && echo "  • $(basename "$file")"
            done
            ;;
            
        enable)
            local module="${3}"
            if [[ -z "$module" ]]; then
                echo.error "Usage: dotfiles modules enable <module>"
                return 1
            fi
            
            if [[ -f "$DOTFILES_MODULES/disabled/$module" ]]; then
                mv "$DOTFILES_MODULES/disabled/$module" "$DOTFILES_MODULES/enabled/"
                echo.success "Enabled module: $module"
            else
                echo.error "Module not found: $module"
            fi
            ;;
            
        disable)
            local module="${3}"
            if [[ -z "$module" ]]; then
                echo.error "Usage: dotfiles modules disable <module>"
                return 1
            fi
            
            if [[ -f "$DOTFILES_MODULES/enabled/$module" ]]; then
                ensure_dir "$DOTFILES_MODULES/disabled"
                mv "$DOTFILES_MODULES/enabled/$module" "$DOTFILES_MODULES/disabled/"
                echo.success "Disabled module: $module"
            else
                echo.error "Module not found: $module"
            fi
            ;;
            
        *)
            echo.error "Unknown command: ${2}"
            echo "Usage: dotfiles modules [list|enable|disable] [module]"
            ;;
    esac
}

function dotfiles_aliases_help() {
    echo
    echo.cyan "Available Aliases:"
    for file in "$DOTFILES_ROOT/modules/aliases"/*.aliases; do
        if [[ -f "$file" ]]; then
            local category=$(basename "$file" .aliases)
            echo "  --- $category ---"
            while IFS= read -r line; do
                if [[ "$line" =~ ^#\ @alias\ (.+) ]]; then
                    local alias_name="${BASH_REMATCH[1]}"
                    read -r desc_line
                    if [[ "$desc_line" =~ ^#\ @desc\ (.+) ]]; then
                        local alias_desc="${BASH_REMATCH[1]}"
                        printf "    %-15s %s\n" "$alias_name" "$alias_desc"
                    fi
                fi
            done < "$file"
        fi
    done
}

function dotfiles_help() {
    echo.header "Dotfiles Management System"
    echo
    echo "Usage: dotfiles <command> [args]"
    echo
    echo.cyan "Core Commands:"
    echo "  help       Show this help"
    echo "  version    Show version information"
    echo "  reload     Reload dotfiles configuration"
    echo "  update     Update dotfiles from git"
    echo "  doctor     Run health check"
    echo "  install    Install dotfiles symlinks"
    echo
    echo.cyan "Module Commands:"
    echo "  modules    Manage modules"
    echo "  new        Create new module/plugin/script"
    echo
    echo.cyan "Management Commands:"
    echo "  link       Symlink manager (dotfiles-link)"
    echo "  env        Environment variables & secrets manager (dotfiles-env)"
    echo "  sync       Environment sync across machines (dotfiles-env-sync)"
    echo "  secrets    Secrets discovery & setup for new machines (dotfiles-secrets-bootstrap)"
    echo "  visualize  Render diagrams (Mermaid)"
    echo "  packages   Manage additional packages (dotfiles-packages)"
    echo
    echo.cyan "Version Commands:"
    echo "  version    Show version information"
    echo "  version bump    Auto-increment version"
    echo "  version set <v> Set specific version"
    echo
    echo.cyan "Quick Actions:"
    echo "  cd         Go to dotfiles directory"
    echo "  edit       Edit dotfiles in $EDITOR"
    echo "  logs       View error logs"
    echo "  studio     Launch Dotfiles Studio (dev) or deploy"
    echo
    dotfiles_aliases_help
    echo
    echo "For command help, use: dotfiles <command> help"
    echo "Example: dotfiles link help"
}

function dotfiles_studio_start() {
    local app_dir="$DOTFILES_ROOT/tools/starship-visual-generator"
    if [[ ! -d "$app_dir" ]]; then
        echo.error "Studio app not found at $app_dir"
        return 1
    fi
    echo.info "Starting Dotfiles Studio in background..."
    (
      cd "$app_dir" && nohup bun run start > "$DOTFILES_ROOT/logs/studio.log" 2>&1 & echo $! > "$DOTFILES_ROOT/logs/studio.pid"
    )
    sleep 1
    local url="http://localhost:5173"
    echo.success "Studio started at ${url}"
    read -r -p "Open in browser? [Y/n] " ans
    ans=${ans:-Y}
    if [[ "$ans" == "Y" || "$ans" == "y" ]]; then
        if command -v xdg-open >/dev/null 2>&1; then xdg-open "$url" >/dev/null 2>&1 &
        elif command -v open >/dev/null 2>&1; then open "$url" >/dev/null 2>&1 &
        else echo.info "Please open $url in your browser"; fi
    fi
    echo.info "Vite server running in background; CLI remains usable"
}

function dotfiles_studio_deploy() {
    local app_dir="$DOTFILES_ROOT/tools/starship-visual-generator"
    if [[ ! -d "$app_dir" ]]; then
        echo.error "Studio app not found at $app_dir"
        return 1
    fi
    if ! command -v vercel >/dev/null 2>&1; then
        echo.error "vercel CLI not found. Install with: npm i -g vercel"
        return 1
    fi
    echo.header "Building and deploying Dotfiles Studio"
    (
      cd "$app_dir" && bun run build
    ) || { echo.error "Build failed"; return 1; }
    local deploy_url
    deploy_url=$(cd "$app_dir" && vercel deploy --prod --yes 2>/dev/null | tail -n 1)
    if [[ -z "$deploy_url" ]]; then
        echo.error "Deploy failed"
        return 1
    fi
    echo.success "Deployed: $deploy_url"
    local alias="dotfiles-studio"
    if (cd "$app_dir" && vercel alias set "$deploy_url" "$alias" >/dev/null 2>&1); then
        echo.success "Alias set: https://$alias.vercel.app"
    else
        local fallback1="${alias}-$(whoami)"
        if (cd "$app_dir" && vercel alias set "$deploy_url" "$fallback1" >/dev/null 2>&1); then
            echo.success "Alias set: https://$fallback1.vercel.app"
        else
            local fallback2="${alias}-$(date +%s)"
            if (cd "$app_dir" && vercel alias set "$deploy_url" "$fallback2" >/dev/null 2>&1); then
                echo.success "Alias set: https://$fallback2.vercel.app"
            else
                echo.warning "Could not set alias; use deployed URL above"
            fi
        fi
    fi
}

case "${1:-help}" in
    version|v)
        if [[ -n "$2" ]]; then
            # Delegate to dotfiles-version for subcommands
            shift
            "$DOTFILES_BIN/dotfiles-version" "$@"
        else
            dotfiles_version
        fi
        ;;
    reload|r)
        dotfiles_reload
        ;;
    update|u)
        dotfiles_update
        ;;
    doctor|check)
        case "$2" in
            animated|a)
                shift 2
                "$DOTFILES_BIN/dotfiles-doctor-animated" "$@"
                ;;
            fast|f)
                "$DOTFILES_BIN/dotfiles-doctor-fast"
                ;;
            *)
                dotfiles_doctor
                ;;
        esac
        ;;
    install|i)
        dotfiles_install
        ;;
    modules|mod|m)
        dotfiles_modules "$@"
        ;;
    new|n)
        shift
        "$DOTFILES_BIN/dotfiles-new" "$@"
        ;;
    link|l)
        shift
        "$DOTFILES_BIN/dotfiles-link" "$@"
        ;;
    env|e)
        shift
        "$DOTFILES_BIN/dotfiles-env" "$@"
        ;;
    sync)
        shift
        "$DOTFILES_BIN/dotfiles-env-sync" "$@"
        ;;
    secrets|secrets-bootstrap)
        shift
        "$DOTFILES_BIN/dotfiles-secrets-bootstrap" "$@"
        ;;
    visualize|viz|diagram)
        shift
        if [[ $# -eq 0 ]]; then
            bash "$DOTFILES_ROOT/scripts/dotfiles-visualize-secrets.sh" secrets
        else
            bash "$DOTFILES_ROOT/scripts/dotfiles-visualize-secrets.sh" "$@"
        fi
        ;;
    cd)
        cd "$DOTFILES_ROOT"
        ;;
    edit)
        ${EDITOR:-vim} "$DOTFILES_ROOT"
        ;;
    logs)
        if [[ -f "$DOTFILES_ERROR_LOG" ]]; then
            tail -n 50 "$DOTFILES_ERROR_LOG"
        else
            echo.info "No error logs found"
        fi
        ;;
    studio)
        case "${2:-start}" in
            start|dev)
                dotfiles_studio_start
                ;;
            deploy)
                dotfiles_studio_deploy
                ;;
            *)
                echo.error "Usage: dotfiles studio [start|deploy]"
                ;;
        esac
        ;;
    help|h|--help|-h)
        dotfiles_help
        ;;
    *)
        echo.error "Unknown command: $1"
        dotfiles_help
        exit 1
        ;;
esac
