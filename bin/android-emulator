#!/usr/bin/env bash

# DOCSTRING: Android Emulator Management Tool
# Comprehensive helper for managing Android emulator and apps

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

android_sdk="$HOME/Android/Sdk"
adb_path="$android_sdk/platform-tools/adb"
emulator_path="$android_sdk/emulator/emulator"
default_avd="Pixel_9_Pro"

show_banner() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘        ğŸ“± ANDROID EMULATOR MANAGEMENT TOOL                   â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

show_menu() {
    show_banner
    echo -e "${YELLOW}Available Commands:${NC}"
    echo ""
    
    echo -e "${GREEN}Usage:${NC} android-emulator <command>"
    echo ""
    echo -e "${CYAN}Commands:${NC}"
    echo ""
    
    echo -e "  ${GREEN}start${NC}           Start Android emulator (with optimizations)"
    echo -e "  ${GREEN}stop${NC}            Stop running emulator"
    echo -e "  ${GREEN}status${NC}          Check emulator status"
    echo -e "  ${GREEN}list${NC}            List available AVDs"
    echo -e "  ${GREEN}devices${NC}          List connected devices"
    echo -e "  ${GREEN}packages${NC}        List installed packages"
    echo -e "  ${GREEN}logcat${NC}          Show device logs (live)"
    echo -e "  ${GREEN}screenshot${NC}     Take screenshot"
    echo ""
    
    echo -e "${YELLOW}Quick App Launchers:${NC}"
    echo ""
    echo -e "  ${GREEN}feeld${NC}           Launch Feeld app"
    echo -e "  ${GREEN}govee${NC}           Launch Govee app"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Run without arguments to show this menu${NC}"
}

check_adb() {
    if [ ! -f "$adb_path" ]; then
        echo -e "${RED}âŒ ADB not found at: $adb_path${NC}"
        echo -e "${YELLOW}ğŸ’¡ Please install Android SDK${NC}"
        return 1
    fi
    return 0
}

check_emulator() {
    if [ ! -f "$emulator_path" ]; then
        echo -e "${RED}âŒ Emulator not found at: $emulator_path${NC}"
        echo -e "${YELLOW}ğŸ’¡ Please install Android SDK${NC}"
        return 1
    fi
    return 0
}

get_devices() {
    local count=$(adb devices 2>/dev/null | tail -n +2 | grep -v '^$' | wc -l)
    echo "$count" | tr -d ' '
}

is_emulator_running() {
    [ "$(get_devices)" -gt 0 ]
}

cmd_start() {
    if ! check_emulator; then
        return 1
    fi
    
    if is_emulator_running; then
        echo -e "${YELLOW}âœ… Emulator is already running${NC}"
        echo -e "${YELLOW}ğŸ’¡ Run 'android-emulator stop' to stop it first${NC}"
        return 0
    fi
    
    echo -e "${YELLOW}ğŸš€ Starting Android emulator in fast mode...${NC}"
    
    # Start with optimizations in background
    nohup $emulator_path -avd $default_avd \
        -no-snapshot-load \
        -no-boot-anim \
        -no-audio \
        -gpu host \
        -accel on \
        -memory 2048 \
        -cores 4 \
        >/dev/null 2>&1 &
    
    echo -e "${CYAN}â³ Waiting for emulator to boot...${NC}"
    
    # Wait for boot completion
    timeout=90
    elapsed=0
    while [ $elapsed -lt $timeout ]; do
        if is_emulator_running; then
            boot_complete=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
            if [ "$boot_complete" = "1" ]; then
                echo -e "${GREEN}âœ… Emulator ready!${NC}"
                return 0
            fi
        fi
        sleep 1
        elapsed=$((elapsed + 1))
        if [ $((elapsed % 5)) -eq 0 ]; then
            echo -n "."
        fi
    done
    echo ""
    
    echo -e "${RED}âŒ Emulator took too long to start${NC}"
    return 1
}

cmd_stop() {
    if ! check_adb; then
        return 1
    fi
    
    if ! is_emulator_running; then
        echo -e "${YELLOW}âš ï¸  No emulator is running${NC}"
        return 0
    fi
    
    echo -e "${YELLOW}ğŸ›‘ Stopping emulator...${NC}"
    
    adb emu kill >/dev/null 2>&1
    
    echo -e "${GREEN}âœ… Emulator stopped${NC}"
}

cmd_status() {
    if ! check_adb; then
        return 1
    fi
    
    echo -e "${CYAN}ğŸ“± Android Emulator Status${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    if is_emulator_running; then
        echo -e "${GREEN}âœ… Emulator is running${NC}"
        
        devices=$(adb devices | tail -n +2 | grep -v '^$')
        echo "Connected devices:"
        echo "$devices"
    else
        echo -e "${RED}âŒ No emulator running${NC}"
    fi
}

cmd_list() {
    if ! check_emulator; then
        return 1
    fi
    
    echo -e "${CYAN}ğŸ“± Available Android Virtual Devices:${NC}"
    echo ""
    $emulator_path -list-avds
    echo ""
}

cmd_devices() {
    if ! check_adb; then
        return 1
    fi
    
    echo -e "${CYAN}ğŸ“± Connected Devices:${NC}"
    echo ""
    adb devices
}

cmd_packages() {
    if ! check_adb; then
        return 1
    fi
    
    if ! is_emulator_running; then
        echo -e "${RED}âŒ No emulator running${NC}"
        echo -e "${YELLOW}ğŸ’¡ Start an emulator first${NC}"
        return 1
    fi
    
    echo -e "${CYAN}ğŸ“¦ Installed Packages on Emulator:${NC}"
    echo ""
    
    if [ $# -gt 1 ]; then
        echo -e "${YELLOW}Searching for: $2${NC}"
        adb shell pm list packages | grep -i "$2" | cut -d: -f2 | sort
    else
        adb shell pm list packages -3 | cut -d: -f2 | sort
    fi
}

cmd_logcat() {
    if ! check_adb; then
        return 1
    fi
    
    if ! is_emulator_running; then
        echo -e "${RED}âŒ No emulator running${NC}"
        return 1
    fi
    
    echo -e "${YELLOW}ğŸ“‹ Showing live logs (Ctrl+C to exit)...${NC}"
    echo ""
    
    adb logcat
}

cmd_screenshot() {
    if ! check_adb; then
        return 1
    fi
    
    if ! is_emulator_running; then
        echo -e "${RED}âŒ No emulator running${NC}"
        return 1
    fi
    
    filename="screenshot-$(date +%Y%m%d-%H%M%S).png"
    path="$HOME/$filename"
    
    adb shell screencap -p > "$path" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ… Screenshot saved: $path${NC}"
    else
        echo -e "${RED}âŒ Failed to take screenshot${NC}"
    fi
}

cmd_feeld() {
    # Use the feeld function (must be available in fish shell)
    feeld
}

cmd_govee() {
    # Use the govee function (must be available in fish shell)
    govee
}

# Main command handler
if [ $# -eq 0 ]; then
    show_menu
    exit 0
fi

command="$1"

case "$command" in
    start)
        cmd_start "$@"
        ;;
    stop)
        cmd_stop "$@"
        ;;
    status)
        cmd_status "$@"
        ;;
    list)
        cmd_list "$@"
        ;;
    devices)
        cmd_devices "$@"
        ;;
    packages)
        cmd_packages "$@"
        ;;
    logcat)
        cmd_logcat "$@"
        ;;
    screenshot)
        cmd_screenshot "$@"
        ;;
    feeld)
        cmd_feeld "$@"
        ;;
    govee)
        cmd_govee "$@"
        ;;
    --help|-h|help)
        show_menu
        ;;
    *)
        echo -e "${RED}âŒ Unknown command: $command${NC}"
        echo ""
        show_menu
        exit 1
        ;;
esac
