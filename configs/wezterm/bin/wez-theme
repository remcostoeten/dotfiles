#!/usr/bin/env bash

# WezTerm Theme Switcher
# Usage: wez-theme [theme-name] [options]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WEZTERM_CONFIG_DIR="$HOME/.config/wezterm"

# Available themes
THEMES=("cozy-candy" "warm-pumpkin")

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

function show_help() {
    echo -e "${BLUE}WezTerm Theme Switcher${NC}"
    echo ""
    echo "Usage: wez-theme [THEME] [OPTIONS]"
    echo ""
    echo "Available themes:"
    for theme in "${THEMES[@]}"; do
        echo "  • ${theme}"
    done
    echo ""
    echo "Options:"
    echo "  -l, --list      List available themes"
    echo "  -c, --current   Show current theme"
    echo "  -h, --help      Show this help"
    echo "  --bg-on         Enable background image"
    echo "  --bg-off        Disable background image"
    echo ""
    echo "Examples:"
    echo "  wez-theme cozy-candy       # Switch to cozy-candy theme"
    echo "  wez-theme warm-pumpkin     # Switch to warm-pumpkin theme"
    echo "  wez-theme --current        # Show current theme"
    echo "  wez-theme --bg-off         # Disable background images"
}

function list_themes() {
    echo -e "${GREEN}Available themes:${NC}"
    for theme in "${THEMES[@]}"; do
        if [[ "${WEZTHEME:-cozy-candy}" == "$theme" ]]; then
            echo -e "  ${GREEN}✓${NC} ${theme} ${YELLOW}(current)${NC}"
        else
            echo -e "    ${theme}"
        fi
    done
}

function show_current() {
    local current="${WEZTHEME:-cozy-candy}"
    echo -e "${GREEN}Current theme:${NC} ${current}"
    
    # Show background status
    local bg_status="${WEZTERM_BG_ENABLED:-true}"
    if [[ "$bg_status" == "true" ]]; then
        echo -e "${GREEN}Background images:${NC} enabled"
    else
        echo -e "${YELLOW}Background images:${NC} disabled"
    fi
}

function set_theme() {
    local theme="$1"
    
    # Validate theme
    local valid=false
    for t in "${THEMES[@]}"; do
        if [[ "$t" == "$theme" ]]; then
            valid=true
            break
        fi
    done
    
    if [[ "$valid" != "true" ]]; then
        echo -e "${RED}Error:${NC} Unknown theme '${theme}'"
        echo "Run 'wez-theme --list' to see available themes"
        exit 1
    fi
    
    # Export theme to current shell
    export WEZTHEME="$theme"
    
    # Update shell profile for persistence
    local shell_profile=""
    if [[ -n "${ZSH_VERSION:-}" ]]; then
        shell_profile="$HOME/.zshrc"
    elif [[ -n "${BASH_VERSION:-}" ]]; then
        shell_profile="$HOME/.bashrc"
    fi
    
    if [[ -n "$shell_profile" && -f "$shell_profile" ]]; then
        # Remove existing WEZTHEME export
        sed -i '/^export WEZTHEME=/d' "$shell_profile"
        
        # Add new export
        echo "export WEZTHEME=\"$theme\"" >> "$shell_profile"
        
        echo -e "${GREEN}✓${NC} Theme set to: ${PURPLE}${theme}${NC}"
        echo -e "${BLUE}Info:${NC} Added export to $shell_profile"
        echo -e "${YELLOW}Note:${NC} Restart WezTerm or open a new terminal to see changes"
    else
        echo -e "${GREEN}✓${NC} Theme set to: ${PURPLE}${theme}${NC} (session only)"
        echo -e "${YELLOW}Note:${NC} Add 'export WEZTHEME=\"$theme\"' to your shell profile for persistence"
    fi
}

function toggle_background() {
    local state="$1"
    
    export WEZTERM_BG_ENABLED="$state"
    
    # Update shell profile
    local shell_profile=""
    if [[ -n "${ZSH_VERSION:-}" ]]; then
        shell_profile="$HOME/.zshrc"
    elif [[ -n "${BASH_VERSION:-}" ]]; then
        shell_profile="$HOME/.bashrc"
    fi
    
    if [[ -n "$shell_profile" && -f "$shell_profile" ]]; then
        sed -i '/^export WEZTERM_BG_ENABLED=/d' "$shell_profile"
        echo "export WEZTERM_BG_ENABLED=\"$state\"" >> "$shell_profile"
    fi
    
    if [[ "$state" == "true" ]]; then
        echo -e "${GREEN}✓${NC} Background images enabled"
    else
        echo -e "${YELLOW}✓${NC} Background images disabled"
    fi
    
    echo -e "${YELLOW}Note:${NC} Restart WezTerm to see changes"
}

# Parse arguments
case "${1:-}" in
    -h|--help)
        show_help
        ;;
    -l|--list)
        list_themes
        ;;
    -c|--current)
        show_current
        ;;
    --bg-on)
        toggle_background "true"
        ;;
    --bg-off)
        toggle_background "false"
        ;;
    "")
        show_current
        ;;
    *)
        set_theme "$1"
        ;;
esac