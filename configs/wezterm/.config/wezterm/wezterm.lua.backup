local wezterm = require 'wezterm'
local config = wezterm.config_builder()

-- ═══════════════════════════════════════════════════════════════════════════════
--  🎨 WezTerm Enhanced Aesthetic Configuration
-- ═══════════════════════════════════════════════════════════════════════════════
--
--  🎯 Feature Overview:
--     • Modern gradient themes with pastel-neon colors
--     • Dynamic background system with blur effects
--     • Powerline tab bar with process icons
--     • Animated status line with git/battery/clock info
--     • Leader-based aesthetic toggles (see key bindings below)
--
--  ⌨️  Quick Keys:
--     • Leader + t : Cycle themes (Cyberdream → Modern Gradient → Catppuccin)
--     • Leader + b : Cycle backgrounds (Solid → Gradient → Image → Glass)
--     • Leader + o : Cycle opacity (100% → 88% → 75% → 65%)
--     • Leader + r : Reload configuration
--
-- ═══════════════════════════════════════════════════════════════════════════════

-- 🔤 Font configuration (enhanced for aesthetics)
config.font = wezterm.font_with_fallback {
  {
    family = 'JetBrains Mono Nerd Font',
    weight = 'Medium',
    harfbuzz_features = { 'calt=1', 'liga=1', 'ss01=1', 'ss02=1', 'zero=1' },
  },
  {
    family = 'Hack Nerd Font',
    harfbuzz_features = { 'calt=1', 'liga=1' },
  },
  { family = 'Symbols Nerd Font Mono' },
}
config.font_size = 16.0
config.line_height = 1.2            -- Improved readability
config.cell_width = 0.9             -- Tighter spacing for modern look
config.freetype_load_target = 'HorizontalLcd'
config.freetype_render_target = 'HorizontalLcd'

-- 🎨 Import aesthetic modules
local modern_gradient = require('themes.modern-gradient')
local background_module = require('modules.background')
local tab_bar_module = require('modules.tab-bar')
local status_line_module = require('modules.status-line')

-- 🌈 Apply modern gradient theme as default
config.colors = require('themes.pumpkin-spice').colors

-- 🖼️  Enhanced window appearance
config.window_decorations = 'RESIZE'                  -- Allow resize with minimal decorations
config.window_close_confirmation = 'NeverPrompt'      -- Quick close
config.adjust_window_size_when_changing_font_size = false

-- 📐 Window padding (optimized for aesthetics)
config.window_padding = {
  left = 20,    -- Slightly more padding for modern look
  right = 20,
  top = 20,
  bottom = 20,
}

-- 🖼️  Window frame configuration (separate from colors palette)
config.window_frame = {
  active_titlebar_bg = '#0F0D15',     -- Dark titlebar
  inactive_titlebar_bg = '#0A0812',   -- Even darker when inactive
  active_titlebar_fg = '#E8E3F3',     -- Light titlebar text
  inactive_titlebar_fg = '#7C6B95',   -- Muted titlebar text
  active_titlebar_border_bottom = '#FF6B9D',    -- Pink accent border
  inactive_titlebar_border_bottom = '#3D2A5C',  -- Purple border
  button_fg = '#B39BC8',              -- Button text
  button_bg = '#2A1F3D',              -- Button background
  button_hover_fg = '#E8E3F3',        -- Button hover text
  button_hover_bg = '#4C3A6B',        -- Button hover background
}

-- 🎨 Window frame styling (separate from colors)
config.window_frame = {
  active_titlebar_bg = '#0F0D15',
  inactive_titlebar_bg = '#0A0812',
  active_titlebar_fg = '#E8E3F3',
  inactive_titlebar_fg = '#7C6B95',
  active_titlebar_border_bottom = '#FF6B9D',
  inactive_titlebar_border_bottom = '#3D2A5C',
  button_fg = '#B39BC8',
  button_bg = '#2A1F3D',
  button_hover_fg = '#E8E3F3',
  button_hover_bg = '#4C3A6B',
}

-- ⚡ Performance and animation settings
config.max_fps = 120                                  -- Smooth animations
config.animation_fps = 60
config.prefer_egl = true
config.enable_wayland = true

-- ✨ Enhanced cursor configuration
config.default_cursor_style = 'BlinkingBar'
config.cursor_blink_rate = 800                        -- Slightly faster blink
config.cursor_thickness = '2px'                       -- Thicker cursor for better visibility
config.cursor_blink_ease_in = 'Constant'
config.cursor_blink_ease_out = 'Constant'

-- 📄 Scrollback and behavior
config.enable_scroll_bar = false
config.scrollback_lines = 10000                       -- More history
config.audible_bell = 'Disabled'
config.visual_bell = {
  fade_in_function = 'EaseIn',
  fade_in_duration_ms = 0,
  fade_out_function = 'EaseOut', 
  fade_out_duration_ms = 0,
}

-- 🌈 Enable enhanced tab bar styling
config.use_fancy_tab_bar = false                      -- Use custom tab bar
config.tab_bar_at_bottom = false                      -- Tabs at top
config.hide_tab_bar_if_only_one_tab = false          -- Always show tab bar
config.show_tab_index_in_tab_bar = false             -- Use icons instead
config.tab_max_width = 25                             -- Reasonable tab width

-- 📎 Window startup size
config.initial_cols = 120
config.initial_rows = 32

-- 🌄 Apply dynamic background configuration with enhanced effects
local bg_config = background_module.getConfig(modern_gradient, 'modern_gradient')
for key, value in pairs(bg_config) do
  config[key] = value
end

-- 🎨 Enhanced visual effects for modern look
config.window_background_opacity = 0.88  -- Semi-transparent
config.text_background_opacity = 0.95    -- Text remains readable
config.inactive_pane_hsb = {
  saturation = 0.8,   -- Slightly desaturated inactive panes
  brightness = 0.6,   -- Dimmer inactive panes
}

-- ✨ Additional aesthetic improvements
config.enable_wayland = true             -- Better Linux integration
config.front_end = 'WebGpu'             -- Modern rendering
config.webgpu_power_preference = 'HighPerformance'

-- 🌌 Background gradient effect (programmatic)
config.window_background_gradient = {
  orientation = 'Vertical',
  colors = {
    '#0F0D15',  -- Deep purple-black (top)
    '#1E1B2E',  -- Medium purple 
    '#2A1F3D',  -- Dark purple
    '#0F0D15',  -- Deep purple-black (bottom)
  },
  interpolation = 'Linear',
  blend = 'Rgb',
}

-- 🔥 Enhanced color effects
config.foreground_text_hsb = {
  hue = 1.0,
  saturation = 1.1,    -- Slightly more vibrant text
  brightness = 1.0,
}

-- 🗂️  Apply tab bar configuration
local tab_config = tab_bar_module.getConfig()
for key, value in pairs(tab_config) do
  config[key] = value
end

-- 🚀 Initialize aesthetic modules
tab_bar_module.setup()
status_line_module.setup()

-- 🎯 Enhanced key bindings for aesthetic controls
config.leader = { key = 'Space', mods = 'CTRL', timeout_milliseconds = 2000 }
config.keys = {
  -- Test key binding
  { key = 'x', mods = 'LEADER', action = wezterm.action.EmitEvent('test-leader') },
  
  -- Aesthetic toggle bindings
  { key = 't', mods = 'LEADER', action = wezterm.action.EmitEvent('cycle-theme') },
  { key = 'b', mods = 'LEADER', action = wezterm.action.EmitEvent('cycle-background') },
  { key = 'o', mods = 'LEADER', action = wezterm.action.EmitEvent('cycle-opacity') },
  { key = 'r', mods = 'LEADER', action = wezterm.action.ReloadConfiguration },
  { key = 'f', mods = 'LEADER', action = wezterm.action.ToggleFullScreen },
  
  -- Standard terminal bindings
  { key = 'c', mods = 'CTRL|SHIFT', action = wezterm.action.CopyTo('Clipboard') },
  { key = 'v', mods = 'CTRL|SHIFT', action = wezterm.action.PasteFrom('Clipboard') },
  { key = '+', mods = 'CTRL|SHIFT', action = wezterm.action.IncreaseFontSize },
  { key = '-', mods = 'CTRL|SHIFT', action = wezterm.action.DecreaseFontSize },
  { key = '0', mods = 'CTRL|SHIFT', action = wezterm.action.ResetFontSize },
  
  -- Tab management
  { key = 't', mods = 'CTRL|SHIFT', action = wezterm.action.SpawnTab('CurrentPaneDomain') },
  { key = 'w', mods = 'CTRL|SHIFT', action = wezterm.action.CloseCurrentTab({ confirm = false }) },
  { key = 'Tab', mods = 'CTRL', action = wezterm.action.ActivateTabRelative(1) },
  { key = 'Tab', mods = 'CTRL|SHIFT', action = wezterm.action.ActivateTabRelative(-1) },
  
  -- Pane management
  { key = 'd', mods = 'CTRL|SHIFT', action = wezterm.action.SplitHorizontal({ domain = 'CurrentPaneDomain' }) },
  { key = 'D', mods = 'CTRL|SHIFT', action = wezterm.action.SplitVertical({ domain = 'CurrentPaneDomain' }) },
  { key = 'h', mods = 'CTRL|SHIFT', action = wezterm.action.ActivatePaneDirection('Left') },
  { key = 'j', mods = 'CTRL|SHIFT', action = wezterm.action.ActivatePaneDirection('Down') },
  { key = 'k', mods = 'CTRL|SHIFT', action = wezterm.action.ActivatePaneDirection('Up') },
  { key = 'l', mods = 'CTRL|SHIFT', action = wezterm.action.ActivatePaneDirection('Right') },
  { key = 'z', mods = 'CTRL|SHIFT', action = wezterm.action.TogglePaneZoomState },
}

-- 🔄 Register background control events with debug info
wezterm.on('cycle-background', function(window, pane)
  wezterm.log_info('cycle-background event triggered')
  background_module.cycleBackground(window, pane)
end)

wezterm.on('cycle-opacity', function(window, pane)
  wezterm.log_info('cycle-opacity event triggered')
  background_module.cycleOpacity(window, pane)
end)

wezterm.on('toggle-background', background_module.toggleBackground)

-- 🗺️ Test event for leader key debugging
wezterm.on('test-leader', function(window, pane)
  window:toast_notification('WezTerm Debug', 'Leader key is working! 🎉', nil, 3000)
end)

-- 🎨 Register theme cycling event with debug info
local themes = require 'modules.themes'
wezterm.on('cycle-theme', function(window, pane)
  wezterm.log_info('cycle-theme event triggered')
  themes._theme_utils.cycle_theme(window, pane)
end)

-- 🍎 Platform-specific settings
if wezterm.target_triple:match('apple') then
  config.macos_window_background_blur = 30
  config.window_decorations = 'RESIZE'
elseif wezterm.target_triple:match('linux') then
  config.enable_wayland = true
  config.window_decorations = 'NONE'
end

-- 🔧 Terminal behavior
config.exit_behavior = 'Close'
config.automatically_reload_config = true
config.check_for_updates = false
config.use_dead_keys = false
config.warn_about_missing_glyphs = false

return config
