#!/usr/bin/env bash

# DOCSTRING: Volume management script with interactive menu and CLI interface
# ============================================================================
# Volume Management Script
# ============================================================================
# Configuration & Globals
# ============================================================================
FUNCTIONS_BRIDGE="$HOME/.config/dotfiles/functions/functions"
if [ -f "$FUNCTIONS_BRIDGE" ]; then
  . "$FUNCTIONS_BRIDGE" 2>/dev/null || source "$FUNCTIONS_BRIDGE" 2>/dev/null || true
fi

if command -v ensure-script-data-dir >/dev/null 2>&1; then
  VOLUME_DATA_DIR="$(ensure-script-data-dir "volume")"
else
  DOTFILES_DATA_DIR="${DOTFILES_DATA_DIR:-$HOME/.dotfiles}"
  VOLUME_DATA_DIR="$DOTFILES_DATA_DIR/volume"
  mkdir -p "$VOLUME_DATA_DIR"
fi

# ============================================================================
# Color & Style Definitions
# ============================================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[0;37m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Pastel colors matching cfg/docker scripts
PASTEL_PINK='\033[38;2;250;162;193m'
PASTEL_MAGENTA='\033[38;2;212;187;248m'
PASTEL_PURPLE='\033[38;2;165;216;255m'
PASTEL_BLUE='\033[38;2;178;242;187m'
PASTEL_CYAN='\033[38;2;255;236;153m'
PASTEL_GREEN='\033[38;2;255;216;168m'
PASTEL_ORANGE='\033[38;2;255;135;135m'
PASTEL_RED='\033[38;2;137;220;235m'

# Emoji/Symbols
CHECK="✓"
CROSS="✗"
ARROW="➜"
STAR="★"
CLOCK="⏱"
POINT="●"
RIGHT="▶"

# ============================================================================
# Utility Functions
# ============================================================================

safe_clear() {
  if [ -t 0 ] && [ -t 1 ]; then
    clear 2>/dev/null || true
  fi
}

get_random() {
  local max="$1"
  if [ -c /dev/urandom ]; then
    local rand=$(od -An -N2 -i /dev/urandom 2>/dev/null | tr -d ' ')
    if [ -n "$rand" ]; then
      echo $((rand % max + 1))
      return
    fi
  fi
  # Fallback: use time and process ID
  echo $((($(date +%s) + $$) % max + 1))
}

get_version() {
  local version_file="$(dirname "$0")/../VERSION"
  if [ -f "$version_file" ]; then
    cat "$version_file" | tr -d '\n'
  else
    echo "unknown"
  fi
}

remove_ansi() {
  echo "$1" | sed 's/\x1b\[[0-9;]*m//g'
}

create_gradient_text() {
  local text="$1"
  local result=""
  local text_len=$(printf '%s' "$text" | wc -c)

  if [ "$text_len" -eq 0 ]; then
    echo "$text"
    return
  fi

  local i=1
  while [ $i -le "$text_len" ]; do
    local char=$(printf '%s' "$text" | cut -c"$i")
    local divisor=$((text_len - 1))
    if [ "$divisor" -eq 0 ]; then
      divisor=1
    fi
    local position=$(((i - 1) * 100 / divisor))
    local color_index=0

    if [ "$position" -lt 17 ]; then
      color_index=0
    elif [ "$position" -lt 33 ]; then
      color_index=1
    elif [ "$position" -lt 50 ]; then
      color_index=2
    elif [ "$position" -lt 67 ]; then
      color_index=3
    elif [ "$position" -lt 83 ]; then
      color_index=4
    else
      color_index=5
    fi

    case $color_index in
    0) result="${result}${PASTEL_PINK}${char}" ;;
    1) result="${result}${PASTEL_MAGENTA}${char}" ;;
    2) result="${result}${PASTEL_PURPLE}${char}" ;;
    3) result="${result}${PASTEL_BLUE}${char}" ;;
    4) result="${result}${PASTEL_CYAN}${char}" ;;
    5) result="${result}${PASTEL_GREEN}${char}" ;;
    esac
    i=$((i + 1))
  done
  printf '%b' "${result}${NC}"
}

show_banner() {
  # Compact Volume ASCII art with gradient colors
  local ascii_lines="
  ${PASTEL_PINK}██╗   ██╗${NC}${PASTEL_MAGENTA} ██████╗ ${NC}${PASTEL_PURPLE}██╗     ${NC}${PASTEL_BLUE}██╗   ██╗${NC}${PASTEL_CYAN}███╗   ███╗${NC}${PASTEL_GREEN}███████╗${NC}
  ${PASTEL_PINK}██║   ██║${NC}${PASTEL_MAGENTA}██╔═══██╗${NC}${PASTEL_PURPLE}██║     ${NC}${PASTEL_BLUE}██║   ██║${NC}${PASTEL_CYAN}████╗ ████║${NC}${PASTEL_GREEN}██╔════╝${NC}
  ${PASTEL_PINK}██║   ██║${NC}${PASTEL_MAGENTA}██║   ██║${NC}${PASTEL_PURPLE}██║     ${NC}${PASTEL_BLUE}██║   ██║${NC}${PASTEL_CYAN}██╔████╔██║${NC}${PASTEL_GREEN}█████╗  ${NC}
  ${PASTEL_PINK}╚██╗ ██╔╝${NC}${PASTEL_MAGENTA}██║   ██║${NC}${PASTEL_PURPLE}██║     ${NC}${PASTEL_BLUE}██║   ██║${NC}${PASTEL_CYAN}██║╚██╔╝██║${NC}${PASTEL_GREEN}██╔══╝  ${NC}
  ${PASTEL_PINK} ╚████╔╝ ${NC}${PASTEL_MAGENTA}╚██████╔╝${NC}${PASTEL_PURPLE}███████╗${NC}${PASTEL_BLUE}╚██████╔╝${NC}${PASTEL_CYAN}██║ ╚═╝ ██║${NC}${PASTEL_GREEN}███████╗${NC}
  ${PASTEL_PINK}  ╚═══╝  ${NC}${PASTEL_MAGENTA} ╚═════╝ ${NC}${PASTEL_PURPLE}╚══════╝${NC}${PASTEL_BLUE} ╚═════╝ ${NC}${PASTEL_CYAN}╚═╝     ╚═╝${NC}${PASTEL_GREEN}╚══════╝${NC}"

  printf '%b\n' "$ascii_lines"
}

# ============================================================================
# Volume Detection & Control
# ============================================================================

detect_volume_tool() {
  if command -v wpctl >/dev/null 2>&1; then
    echo "wpctl"
  elif command -v amixer >/dev/null 2>&1; then
    echo "amixer"
  else
    echo ""
  fi
}

get_current_volume() {
  local tool=$(detect_volume_tool)
  local volume=0

  if [ "$tool" = "wpctl" ]; then
    local wpctl_output=$(wpctl get-volume @DEFAULT_AUDIO_SINK@ 2>/dev/null)
    local vol_str=$(echo "$wpctl_output" | sed -n 's/.*Volume:[[:space:]]*\([0-9.]*\).*/\1/p')
    if [ -n "$vol_str" ]; then
      volume=$(echo "scale=0; $vol_str * 100 / 1" | bc)
    fi
  elif [ "$tool" = "amixer" ]; then
    local amixer_output=$(amixer get Master 2>/dev/null)
    volume=$(echo "$amixer_output" | sed -n 's/.*\[\([0-9]*\)%\].*/\1/p' | head -1)
  fi

  if [ -z "$volume" ] || [ "$volume" = "" ]; then
    volume=0
  fi

  echo "$volume"
}

set_volume() {
  local target_volume="$1"
  local tool=$(detect_volume_tool)

  if [ -z "$tool" ]; then
    echo -e "${RED}${CROSS}${NC} No volume control tool found (wpctl or amixer required)" >&2
    return 1
  fi

  if [ "$tool" = "wpctl" ]; then
    local wpctl_volume=$(echo "scale=2; $target_volume / 100" | bc)
    wpctl set-volume @DEFAULT_AUDIO_SINK@ "$wpctl_volume" 2>/dev/null
  elif [ "$tool" = "amixer" ]; then
    amixer set Master "$target_volume%" 2>/dev/null >/dev/null
  fi
}

# ============================================================================
# Math Functions
# ============================================================================

calculate_relative_increase() {
  local current="$1"
  local percent="$2"
  echo "scale=2; $current + ($current * $percent / 100)" | bc
}

calculate_relative_decrease() {
  local current="$1"
  local percent="$2"
  echo "scale=2; $current - ($current * $percent / 100)" | bc
}

round_volume() {
  local volume="$1"
  printf "%.0f" "$volume"
}

# ============================================================================
# Input Functions
# ============================================================================

read_number() {
  local prompt="$1"
  local min="${2:-0}"
  local max="${3:-100}"
  local value=""

  # Ensure terminal is in sane mode (not raw) for reading text input
  local old_stty=$(stty -g 2>/dev/null)
  stty sane 2>/dev/null

  while true; do
    printf '%b' "${CYAN}${POINT}${NC} ${WHITE}$prompt${NC}: "
    read -r value

    # Strip ANSI escape sequences and control characters
    value=$(echo "$value" | sed 's/\x1b\[[0-9;]*[a-zA-Z]//g' | sed 's/\x1b\[[0-9;]*m//g' | tr -d '\000-\037\177-\377')

    # Remove any remaining non-printable characters
    value=$(printf '%s' "$value" | tr -d '[:cntrl:]')

    # Check if it's a valid number
    if ! echo "$value" | grep -qE '^[0-9]+(\.[0-9]+)?$'; then
      echo -e "${RED}${CROSS}${NC} Please enter a valid number"
      continue
    fi

    # Check bounds - use awk for safer comparison
    local value_num=$(echo "$value" | awk '{printf "%.2f", $1}')
    local min_num=$(echo "$min" | awk '{printf "%.2f", $1}')
    local max_num=$(echo "$max" | awk '{printf "%.2f", $1}')

    if [ -n "$value_num" ] && [ -n "$min_num" ] && [ "$(echo "$value_num < $min_num" | bc -l 2>/dev/null)" = "1" ]; then
      echo -e "${RED}${CROSS}${NC} Value must be at least $min"
      continue
    fi

    if [ -n "$value_num" ] && [ -n "$max_num" ] && [ "$(echo "$value_num > $max_num" | bc -l 2>/dev/null)" = "1" ]; then
      echo -e "${RED}${CROSS}${NC} Value must be at most $max"
      continue
    fi

    # Restore terminal settings before returning
    stty "$old_stty" 2>/dev/null

    echo "$value"
    return 0
  done
}

confirm_action() {
  local prompt="$1"
  local response=""

  # Ensure terminal is in sane mode (not raw) for reading text input
  local old_stty=$(stty -g 2>/dev/null)
  stty sane 2>/dev/null

  while true; do
    printf '%b' "${CYAN}${POINT}${NC} ${WHITE}$prompt${NC} (y/n): "
    read -r response

    # Strip ANSI escape sequences and control characters
    response=$(echo "$response" | sed 's/\x1b\[[0-9;]*[a-zA-Z]//g' | sed 's/\x1b\[[0-9;]*m//g' | tr -d '\000-\037\177-\377')
    response=$(printf '%s' "$response" | tr -d '[:cntrl:]')
    response=$(echo "$response" | tr '[:upper:]' '[:lower:]')

    case "$response" in
    y | yes)
      stty "$old_stty" 2>/dev/null
      return 0
      ;;
    n | no)
      stty "$old_stty" 2>/dev/null
      return 1
      ;;
    *)
      echo -e "${YELLOW}Please enter 'y' or 'n'${NC}"
      ;;
    esac
  done
}

# ============================================================================
# Interactive Menu Functions
# ============================================================================

read_arrow_key() {
  local key=""
  local char=""
  local old_stty=""
  local seq=""

  # Save terminal settings only if we have a terminal
  if [ -t 0 ]; then
    old_stty=$(stty -g 2>/dev/null)
    # Use cbreak mode instead of raw - more reliable for interactive input
    # cbreak: characters available immediately, but signals still work
    stty cbreak -echo 2>/dev/null || stty raw -echo 2>/dev/null
  fi

  # Read first character
  IFS= read -r -n 1 char 2>/dev/null || char=$(dd bs=1 count=1 2>/dev/null)

  # Check for ESC sequence (arrow keys start with ESC)
  if [ "$char" = "$(printf '\033')" ]; then
    # Read the rest of the escape sequence (should be [A, [B, [C, or [D for arrows)
    IFS= read -r -n 2 seq 2>/dev/null || seq=$(dd bs=1 count=2 2>/dev/null)
    case "$seq" in
    "[A") key="up" ;;
    "[B") key="down" ;;
    "[C") key="right" ;;
    "[D") key="left" ;;
    *) key="escape" ;;
    esac
  elif [ "$char" = "$(printf '\r')" ] || [ "$char" = "$(printf '\n')" ]; then
    key="enter"
  elif [ "$char" = "o" ] || [ "$char" = "O" ]; then
    key="o"
  elif [ "$char" = "m" ] || [ "$char" = "M" ]; then
    key="m"
  elif [ "$char" = "x" ] || [ "$char" = "X" ]; then
    key="x"
  elif [ "$char" = "q" ] || [ "$char" = "Q" ]; then
    key="q"
  elif [ -n "$char" ]; then
    # Convert to lowercase for consistency
    key=$(echo "$char" | tr '[:upper:]' '[:lower:]')
  else
    key=""
  fi

  # Restore terminal settings immediately
  if [ -n "$old_stty" ] && [ -t 0 ]; then
    stty "$old_stty" 2>/dev/null
  fi

  echo "$key"
}

show_interactive_menu() {
  local selected=0
  local menu_items="View current volume|Increase volume|Decrease volume|Set volume to specific value|Help"
  local item_count=5

  while true; do
    safe_clear
    show_banner
    echo -e "${CYAN}${ARROW}${NC} ${BOLD}Select an option:${NC}"
    echo ""

    local i=0
    for item in View\ current\ volume Increase\ volume Decrease\ volume Set\ volume\ to\ specific\ value Help; do
      if [ $i -eq $selected ]; then
        echo -e "  ${GREEN}${RIGHT}${NC} ${BOLD}${WHITE}$((i + 1)). $item${NC}"
      else
        echo -e "    ${DIM}$((i + 1)). $item${NC}"
      fi
      i=$((i + 1))
    done

    echo ""
    echo -e "${DIM}Use arrow keys to navigate, Enter to select${NC}"

    local key=$(read_arrow_key)
    
    # Handle empty key (timeout or invalid input)
    if [ -z "$key" ]; then
      continue
    fi

    case "$key" in
    up)
      selected=$((selected - 1))
      if [ $selected -lt 0 ]; then
        selected=$((item_count - 1))
      fi
      ;;
    down)
      selected=$((selected + 1))
      if [ $selected -ge $item_count ]; then
        selected=0
      fi
      ;;
    enter)
      case $selected in
      0)
        safe_clear
        show_banner
        view_current_volume
        wait_for_key
        ;;
      1)
        safe_clear
        show_banner
        increase_volume_interactive
        wait_for_key
        ;;
      2)
        safe_clear
        show_banner
        decrease_volume_interactive
        wait_for_key
        ;;
      3)
        safe_clear
        show_banner
        set_volume_interactive
        wait_for_key
        ;;
      4)
        show_help
        ;;
      esac
      ;;
    escape | q)
      echo ""
      echo -e "${GREEN}${CHECK}${NC} Goodbye!"
      exit 0
      ;;
    esac
  done
}

wait_for_key() {
  echo ""
  echo -e "${DIM}Press any key to continue...${NC}"
  # Use a simple read approach that doesn't interfere with terminal state
  # This prevents blinking and works reliably
  if [ -t 0 ]; then
    # Save terminal state
    local old_stty=$(stty -g 2>/dev/null)
    # Set to cbreak mode: characters available immediately, but not raw
    stty cbreak -echo 2>/dev/null
    # Read a single character
    dd bs=1 count=1 2>/dev/null >/dev/null
    # Restore terminal state
    stty "$old_stty" 2>/dev/null
  else
    # If not a terminal, just read a line
    read
  fi
}

# ============================================================================
# Volume Operations
# ============================================================================

view_current_volume() {
  local volume=$(get_current_volume)
  echo ""
  echo -e "${GREEN}${CHECK}${NC} ${BOLD}Current volume: ${WHITE}${volume}%${NC}"
}

increase_volume_interactive() {
  local current=$(get_current_volume)
  echo ""
  echo -e "${CYAN}${POINT}${NC} ${WHITE}Current volume: ${BOLD}${current}%${NC}"

  local percent=$(read_number "By what percentage do you want to increase" 0)
  local new_volume=$(calculate_relative_increase "$current" "$percent")
  local rounded=$(round_volume "$new_volume")

  if [ "$rounded" -gt 100 ]; then
    rounded=100
  fi

  echo ""
  echo -e "${CYAN}${POINT}${NC} ${WHITE}New volume will be: ${BOLD}${rounded}%${NC}"

  if [ "$rounded" -gt 90 ]; then
    if ! confirm_action "Warning: Volume will be very high (${rounded}%). Continue"; then
      return
    fi
  else
    if ! confirm_action "Apply this volume"; then
      return
    fi
  fi

  set_volume "$rounded"
  echo ""
  echo -e "${GREEN}${CHECK}${NC} ${BOLD}Volume set to: ${WHITE}${rounded}%${NC}"
}

decrease_volume_interactive() {
  local current=$(get_current_volume)
  echo ""
  echo -e "${CYAN}${POINT}${NC} ${WHITE}Current volume: ${BOLD}${current}%${NC}"

  local percent=$(read_number "By what percentage do you want to decrease" 0)
  local new_volume=$(calculate_relative_decrease "$current" "$percent")
  local rounded=$(round_volume "$new_volume")

  if [ "$rounded" -lt 0 ]; then
    rounded=0
  fi

  echo ""
  echo -e "${CYAN}${POINT}${NC} ${WHITE}New volume will be: ${BOLD}${rounded}%${NC}"

  if ! confirm_action "Apply this volume"; then
    return
  fi

  set_volume "$rounded"
  echo ""
  echo -e "${GREEN}${CHECK}${NC} ${BOLD}Volume set to: ${WHITE}${rounded}%${NC}"
}

set_volume_interactive() {
  local current=$(get_current_volume)
  echo ""
  echo -e "${CYAN}${POINT}${NC} ${WHITE}Current volume: ${BOLD}${current}%${NC}"
  echo ""
  
  local target=$(read_number "Enter volume level (0-100)" 0 100)
  local rounded=$(round_volume "$target")

  if [ "$rounded" -gt 90 ]; then
    if ! confirm_action "Warning: Volume will be very high (${rounded}%). Continue"; then
      return
    fi
  else
    if ! confirm_action "Set volume to ${rounded}%"; then
      return
    fi
  fi

  set_volume "$rounded"
  echo ""
  echo -e "${GREEN}${CHECK}${NC} ${BOLD}Volume set to: ${WHITE}${rounded}%${NC}"
}

handle_high_volume() {
  local volume="$1"
  local current=$(get_current_volume)

  safe_clear
  show_banner
  echo -e "${YELLOW}${CLOCK}${NC} ${BOLD}100 is the highest volume can go, do you want to:${NC}"
  echo ""
  echo -e "  ${GREEN}1.${NC} Set to another value [o]"
  echo -e "  ${GREEN}2.${NC} Set to maximum [m]"
  echo -e "  ${GREEN}3.${NC} Cancel [x]"
  echo ""

  local selected=0
  while true; do
    local key=$(read_arrow_key)
    
    # Handle empty key (timeout or invalid input)
    if [ -z "$key" ]; then
      continue
    fi

    case "$key" in
    up)
      selected=$((selected - 1))
      if [ $selected -lt 0 ]; then
        selected=2
      fi
      ;;
    down)
      selected=$((selected + 1))
      if [ $selected -gt 2 ]; then
        selected=0
      fi
      ;;
    o | O)
      selected=0
      ;;
    m | M)
      selected=1
      ;;
    x | X)
      selected=2
      ;;
    enter)
      case $selected in
      0)
        echo ""
        echo -e "${CYAN}${POINT}${NC} ${WHITE}Current volume is ${current}%, what volume do you want:${NC}"
        local new_target=$(read_number "Enter volume level" 0 100)
        local new_rounded=$(round_volume "$new_target")

        if [ "$new_rounded" -gt 90 ]; then
          if ! confirm_action "Warning: Volume will be very high (${new_rounded}%). Continue"; then
            return
          fi
        fi

        set_volume "$new_rounded"
        echo ""
        echo -e "${GREEN}${CHECK}${NC} ${BOLD}Volume set to: ${WHITE}${new_rounded}%${NC}"
        return
        ;;
      1)
        set_volume 100
        echo ""
        echo -e "${GREEN}${CHECK}${NC} ${BOLD}Volume set to maximum: ${WHITE}100%${NC}"
        return
        ;;
      2)
        local goodbyes="goodbye ciao later hoedoe"
        local count=$(echo "$goodbyes" | wc -w)
        local index=$(get_random "$count")
        local goodbye=$(echo "$goodbyes" | cut -d' ' -f$index)
        echo ""
        echo -e "${GREEN}${CHECK}${NC} $goodbye!"
        exit 0
        ;;
      esac
      ;;
    escape | q)
      local goodbyes="goodbye ciao later hoedoe"
      local count=$(echo "$goodbyes" | wc -w)
      local index=$(get_random "$count")
      local goodbye=$(echo "$goodbyes" | cut -d' ' -f$index)
      echo ""
      echo -e "${GREEN}${CHECK}${NC} $goodbye!"
      exit 0
      ;;
    esac

    # Redraw menu
    safe_clear
    show_banner
    echo -e "${YELLOW}${CLOCK}${NC} ${BOLD}100 is the highest volume can go, do you want to:${NC}"
    echo ""
    local i=0
    for option in "Set to another value [o]" "Set to maximum [m]" "Cancel [x]"; do
      if [ $i -eq $selected ]; then
        echo -e "  ${GREEN}${RIGHT}${NC} ${BOLD}${WHITE}$((i + 1)). $option${NC}"
      else
        echo -e "    ${DIM}$((i + 1)). $option${NC}"
      fi
      i=$((i + 1))
    done
    echo ""
  done
}

# ============================================================================
# Direct Command Operations
# ============================================================================

increase_volume_direct() {
  local percent="$1"
  local current=$(get_current_volume)

  if [ -z "$percent" ]; then
    echo -e "${RED}${CROSS}${NC} Percentage required for 'volume up X'" >&2
    exit 1
  fi

  # Validate percentage
  if ! echo "$percent" | grep -qE '^[0-9]+(\.[0-9]+)?$'; then
    echo -e "${RED}${CROSS}${NC} Invalid percentage: $percent" >&2
    exit 1
  fi

  if [ "$(echo "$percent > 100" | bc -l)" -eq 1 ]; then
    handle_high_volume "$percent"
    return
  fi

  local new_volume=$(calculate_relative_increase "$current" "$percent")
  local rounded=$(round_volume "$new_volume")

  if [ "$rounded" -gt 100 ]; then
    rounded=100
  fi

  set_volume "$rounded"
  echo -e "${GREEN}${CHECK}${NC} Volume increased to ${rounded}%"
}

decrease_volume_direct() {
  local percent="$1"
  local current=$(get_current_volume)

  if [ -z "$percent" ]; then
    echo -e "${RED}${CROSS}${NC} Percentage required for 'volume down X'" >&2
    exit 1
  fi

  # Validate percentage
  if ! echo "$percent" | grep -qE '^[0-9]+(\.[0-9]+)?$'; then
    echo -e "${RED}${CROSS}${NC} Invalid percentage: $percent" >&2
    exit 1
  fi

  local new_volume=$(calculate_relative_decrease "$current" "$percent")
  local rounded=$(round_volume "$new_volume")

  if [ "$rounded" -lt 0 ]; then
    rounded=0
  fi

  set_volume "$rounded"
  echo -e "${GREEN}${CHECK}${NC} Volume decreased to ${rounded}%"
}

set_volume_direct() {
  local target="$1"

  if [ -z "$target" ]; then
    echo -e "${RED}${CROSS}${NC} Volume level required" >&2
    exit 1
  fi

  # Validate number
  if ! echo "$target" | grep -qE '^[0-9]+(\.[0-9]+)?$'; then
    echo -e "${RED}${CROSS}${NC} Invalid volume level: $target" >&2
    exit 1
  fi

  local rounded=$(round_volume "$target")

  if [ "$rounded" -gt 100 ]; then
    echo "The maximum volume is 100"
    exit 0
  fi

  set_volume "$rounded"
  echo -e "${GREEN}${CHECK}${NC} Volume set to ${rounded}%"
}

# ============================================================================
# Help Menu
# ============================================================================

show_help() {
  local interactive="${1:-1}"  # Default to interactive (1), 0 for non-interactive
  
  # If non-interactive (called from CLI), skip clear and banner, just print and exit
  if [ "$interactive" = "0" ]; then
    echo -e "${BOLD}${CYAN}USAGE:${NC}"
    echo -e "  ${WHITE}volume${NC} ${DIM}[command] [options]${NC}"
    echo ""
    echo -e "${BOLD}${CYAN}INTERACTIVE MODE:${NC}"
    echo -e "  ${GREEN}volume${NC}                        ${DIM}# Start interactive menu${NC}"
    echo ""
    echo -e "${BOLD}${CYAN}DIRECT COMMANDS:${NC}"
    echo -e "  ${GREEN}volume up X${NC}                  ${DIM}# Increase volume by X% (relative)${NC}"
    echo -e "  ${GREEN}volume down X${NC}                 ${DIM}# Decrease volume by X% (relative)${NC}"
    echo -e "  ${GREEN}volume NUMBER${NC}                 ${DIM}# Set volume to NUMBER% (capped at 100)${NC}"
    echo -e "  ${GREEN}volume help${NC}                   ${DIM}# Show this help menu${NC}"
    echo ""
    echo -e "${BOLD}${CYAN}RELATIVE PERCENTAGE EXAMPLES:${NC}"
    echo -e "  ${DIM}# Current: 10%, volume up 100% → 20% (100% of 10 = 10, so 10+10=20)${NC}"
    echo -e "  ${DIM}# Current: 40%, volume up 12% → 44.8% (12% of 40 = 4.8, so 40+4.8=44.8)${NC}"
    echo -e "  ${DIM}# Current: 55%, volume down 25% → 41.25% (25% of 55 = 13.75, so 55-13.75=41.25)${NC}"
    echo ""
    echo -e "${BOLD}${CYAN}INTERACTIVE MENU OPTIONS:${NC}"
    echo -e "  ${GREEN}1.${NC} View current volume"
    echo -e "  ${GREEN}2.${NC} Increase volume (with relative percentage)"
    echo -e "  ${GREEN}3.${NC} Decrease volume (with relative percentage)"
    echo -e "  ${GREEN}4.${NC} Set volume to a specific value"
    echo -e "  ${GREEN}5.${NC} Help"
    echo ""
    echo -e "${BOLD}${CYAN}SCRIPT PATHS:${NC}"
    echo -e "  ${DIM}~/.config/dotfiles/scripts/volume-management${NC}"
    echo -e "  ${DIM}~/.config/dotfiles/bin/volume${NC}"
    return 0
  fi

  # Interactive mode (from menu)
  safe_clear
  show_banner
  echo -e "${BOLD}${CYAN}USAGE:${NC}"
  echo -e "  ${WHITE}volume${NC} ${DIM}[command] [options]${NC}"
  echo ""
  echo -e "${BOLD}${CYAN}INTERACTIVE MODE:${NC}"
  echo -e "  ${GREEN}volume${NC}                        ${DIM}# Start interactive menu${NC}"
  echo ""
  echo -e "${BOLD}${CYAN}DIRECT COMMANDS:${NC}"
  echo -e "  ${GREEN}volume up X${NC}                  ${DIM}# Increase volume by X% (relative)${NC}"
  echo -e "  ${GREEN}volume down X${NC}                 ${DIM}# Decrease volume by X% (relative)${NC}"
  echo -e "  ${GREEN}volume NUMBER${NC}                 ${DIM}# Set volume to NUMBER% (capped at 100)${NC}"
  echo -e "  ${GREEN}volume help${NC}                   ${DIM}# Show this help menu${NC}"
  echo ""
  echo -e "${BOLD}${CYAN}RELATIVE PERCENTAGE EXAMPLES:${NC}"
  echo -e "  ${DIM}# Current: 10%, volume up 100% → 20% (100% of 10 = 10, so 10+10=20)${NC}"
  echo -e "  ${DIM}# Current: 40%, volume up 12% → 44.8% (12% of 40 = 4.8, so 40+4.8=44.8)${NC}"
  echo -e "  ${DIM}# Current: 55%, volume down 25% → 41.25% (25% of 55 = 13.75, so 55-13.75=41.25)${NC}"
  echo ""
  echo -e "${BOLD}${CYAN}INTERACTIVE MENU OPTIONS:${NC}"
  echo -e "  ${GREEN}1.${NC} View current volume"
  echo -e "  ${GREEN}2.${NC} Increase volume (with relative percentage)"
  echo -e "  ${GREEN}3.${NC} Decrease volume (with relative percentage)"
  echo -e "  ${GREEN}4.${NC} Set volume to a specific value"
  echo -e "  ${GREEN}5.${NC} Help"
  echo ""
  echo -e "${BOLD}${CYAN}SCRIPT PATHS:${NC}"
  echo -e "  ${DIM}~/.config/dotfiles/scripts/volume-management${NC}"
  echo -e "  ${DIM}~/.config/dotfiles/bin/volume${NC}"
  echo ""
  echo -e "${BOLD}${CYAN}OPEN SCRIPT:${NC}"
  echo -e "  ${GREEN}1.${NC} Open in nvim [n]"
  echo -e "  ${GREEN}2.${NC} Open in Cursor [c]"
  echo -e "  ${GREEN}3.${NC} Open GitHub repo [g]"
  echo -e "  ${GREEN}4.${NC} Back [b]"
  echo ""

  local selected=0
  while true; do
    local key=$(read_arrow_key)
    
    # Handle empty key (timeout or invalid input)
    if [ -z "$key" ]; then
      continue
    fi

    case "$key" in
    up)
      selected=$((selected - 1))
      if [ $selected -lt 0 ]; then
        selected=3
      fi
      ;;
    down)
      selected=$((selected + 1))
      if [ $selected -gt 3 ]; then
        selected=0
      fi
      ;;
    n | N)
      selected=0
      ;;
    c | C)
      selected=1
      ;;
    g | G)
      selected=2
      ;;
    b | B)
      return
      ;;
    enter)
      case $selected in
      0)
        nvim "$HOME/.config/dotfiles/scripts/volume-management" 2>/dev/null ||
          vi "$HOME/.config/dotfiles/scripts/volume-management" 2>/dev/null ||
          echo -e "${YELLOW}Could not open in nvim${NC}"
        return
        ;;
      1)
        cursor "$HOME/.config/dotfiles/scripts/volume-management" 2>/dev/null ||
          code "$HOME/.config/dotfiles/scripts/volume-management" 2>/dev/null ||
          echo -e "${YELLOW}Could not open in Cursor${NC}"
        return
        ;;
      2)
        xdg-open "https://github.com/remcostoeten/dotfiles/tree/master/scripts/volume-management" 2>/dev/null ||
          echo -e "${YELLOW}Could not open browser${NC}"
        return
        ;;
      3)
        return
        ;;
      esac
      ;;
    escape | q)
      return
      ;;
    esac

    # Redraw menu
    safe_clear
    show_banner
    echo -e "${BOLD}${CYAN}USAGE:${NC}"
    echo -e "  ${WHITE}volume${NC} ${DIM}[command] [options]${NC}"
    echo ""
    echo -e "${BOLD}${CYAN}INTERACTIVE MODE:${NC}"
    echo -e "  ${GREEN}volume${NC}                        ${DIM}# Start interactive menu${NC}"
    echo ""
    echo -e "${BOLD}${CYAN}DIRECT COMMANDS:${NC}"
    echo -e "  ${GREEN}volume up X${NC}                  ${DIM}# Increase volume by X% (relative)${NC}"
    echo -e "  ${GREEN}volume down X${NC}                 ${DIM}# Decrease volume by X% (relative)${NC}"
    echo -e "  ${GREEN}volume NUMBER${NC}                 ${DIM}# Set volume to NUMBER% (capped at 100)${NC}"
    echo -e "  ${GREEN}volume help${NC}                   ${DIM}# Show this help menu${NC}"
    echo ""
    echo -e "${BOLD}${CYAN}RELATIVE PERCENTAGE EXAMPLES:${NC}"
    echo -e "  ${DIM}# Current: 10%, volume up 100% → 20% (100% of 10 = 10, so 10+10=20)${NC}"
    echo -e "  ${DIM}# Current: 40%, volume up 12% → 44.8% (12% of 40 = 4.8, so 40+4.8=44.8)${NC}"
    echo -e "  ${DIM}# Current: 55%, volume down 25% → 41.25% (25% of 55 = 13.75, so 55-13.75=41.25)${NC}"
    echo ""
    echo -e "${BOLD}${CYAN}INTERACTIVE MENU OPTIONS:${NC}"
    echo -e "  ${GREEN}1.${NC} View current volume"
    echo -e "  ${GREEN}2.${NC} Increase volume (with relative percentage)"
    echo -e "  ${GREEN}3.${NC} Decrease volume (with relative percentage)"
    echo -e "  ${GREEN}4.${NC} Set volume to a specific value"
    echo -e "  ${GREEN}5.${NC} Help"
    echo ""
    echo -e "${BOLD}${CYAN}SCRIPT PATHS:${NC}"
    echo -e "  ${DIM}~/.config/dotfiles/scripts/volume-management${NC}"
    echo -e "  ${DIM}~/.config/dotfiles/bin/volume${NC}"
    echo ""
    echo -e "${BOLD}${CYAN}OPEN SCRIPT:${NC}"
    local i=0
    for option in "Open in nvim [n]" "Open in Cursor [c]" "Open GitHub repo [g]" "Back [b]"; do
      if [ $i -eq $selected ]; then
        echo -e "  ${GREEN}${RIGHT}${NC} ${BOLD}${WHITE}$((i + 1)). $option${NC}"
      else
        echo -e "    ${DIM}$((i + 1)). $option${NC}"
      fi
      i=$((i + 1))
    done
    echo ""
  done
}

# ============================================================================
# Main
# ============================================================================

main() {
  # Check for bc (required for math)
  if ! command -v bc >/dev/null 2>&1; then
    echo -e "${RED}${CROSS}${NC} 'bc' is required but not installed" >&2
    echo -e "${YELLOW}Install with: sudo apt install bc${NC}" >&2
    exit 1
  fi

  # Check for volume tool
  local tool=$(detect_volume_tool)
  if [ -z "$tool" ]; then
    echo -e "${RED}${CROSS}${NC} No volume control tool found (wpctl or amixer required)" >&2
    exit 1
  fi

  # Parse arguments
  if [ $# -eq 0 ]; then
    show_interactive_menu
  else
    case "$1" in
    help | --help | -h)
      show_help 0  # 0 = non-interactive mode
      ;;
    up)
      increase_volume_direct "$2"
      ;;
    down)
      decrease_volume_direct "$2"
      ;;
    *)
      # Try to parse as number
      if echo "$1" | grep -qE '^[0-9]+(\.[0-9]+)?$'; then
        set_volume_direct "$1"
      else
        echo -e "${RED}${CROSS}${NC} Unknown command: $1" >&2
        echo -e "${DIM}Use 'volume help' for usage information${NC}" >&2
        exit 1
      fi
      ;;
    esac
  fi
}

main "$@"
