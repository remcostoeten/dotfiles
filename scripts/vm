#!/bin/bash

# VM Manager - Comprehensive Virtual Machine Management
# Consolidates the best features from all VM scripts
# Supports Multipass, VirtualBox, QEMU, and Docker containers

set -e

# Colors and styling
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
GRAY='\033[0;37m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Box drawing characters
BOX_H='─'
BOX_V='│'
BOX_TL='╭'
BOX_TR='╮'
BOX_BL='╰'
BOX_BR='╯'

# Configuration
VM_DIR="${HOME}/vms"
VM_CONFIG_DIR="${HOME}/.config/vm-manager"
mkdir -p "$VM_DIR" "$VM_CONFIG_DIR" "$VM_DIR/isos"

# Print functions
draw_header_line() {
    local width="$1"
    local left="$2"
    local fill="$3"
    local right="$4"
    printf "%b" "${left}"
    printf '%*s' "$width" '' | tr ' ' "$fill"
    printf "%b\n" "${right}"
}

draw_centered_text() {
    local width="$1"
    local text="$2"
    # strip ANSI for length calc
    local clean=$(echo -e "$text" | sed 's/\x1b\[[0-9;]*m//g')
    local pad=$(( (width - ${#clean}) / 2 ))
    (( pad < 0 )) && pad=0
    printf '║'
    printf '%*s' "$pad" ''
    printf "%b" "$text"
    printf '%*s' $(( width - pad - ${#clean} )) ''
    printf '║\n'
}

print_header() {
    local title="$1"
    local width=80
    echo
    draw_header_line $width "${BOX_TL}" "${BOX_H}" "${BOX_TR}"
    local empty_line="${BOX_V}$(printf '%*s' $((width-2)) '')${BOX_V}"
    printf "$empty_line\n"
    draw_centered_text $width "${CYAN}${BOLD}$title${NC}"
    printf "$empty_line\n"
    draw_header_line $width "${BOX_BL}" "${BOX_H}" "${BOX_BR}"
    echo
}

print_box() {
    local title="$1"
    local color="${2:-$CYAN}"
    echo -e "${color}${BOLD}┌─ $title ─────────────────────────────────────────────────────┐${NC}"
    echo
}

print_menu_item() {
    local number="$1"
    local title="$2"
    local description="$3"
    local color="${4:-$WHITE}"

    printf "  ${color}%s)${NC} ${BOLD}%s${NC}" "$number" "$title"
    if [ -n "$description" ]; then
        printf " ${DIM}- %s${NC}" "$description"
    fi
    echo
}

print_status() {
    local type="$1"
    local message="$2"

    case "$type" in
        "success")
            echo -e "${GREEN}✓${NC} $message"
            ;;
        "error")
            echo -e "${RED}✗${NC} $message"
            ;;
        "warning")
            echo -e "${YELLOW}⚠${NC} $message"
            ;;
        "info")
            echo -e "${BLUE}ℹ${NC} $message"
            ;;
        *)
            echo -e "$message"
            ;;
    esac
}

# Check dependencies
check_dependencies() {
    local missing=()

    # Check core dependencies
    for cmd in curl wget; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            missing+=("$cmd")
        fi
    done

    # Check VM providers
    local providers_available=()

    if command -v multipass >/dev/null 2>&1; then
        providers_available+=("Multipass")
    fi

    if command -v VBoxManage >/dev/null 2>&1; then
        providers_available+=("VirtualBox")
    fi

    if command -v qemu-system-x86_64 >/dev/null 2>&1; then
        providers_available+=("QEMU")
    fi

    if command -v docker >/dev/null 2>&1; then
        providers_available+=("Docker")
    fi

    if [ ${#missing[@]} -gt 0 ]; then
        print_status "error" "Missing dependencies: ${missing[*]}"
        echo -e "${YELLOW}Install with: sudo apt install ${missing[*]}${NC}"
        return 1
    fi

    if [ ${#providers_available[@]} -eq 0 ]; then
        print_status "warning" "No VM providers found. Install Multipass, VirtualBox, QEMU, or Docker"
        echo -e "${YELLOW}Quick install: sudo snap install multipass${NC}"
        return 1
    fi

    return 0
}

# Download ISO with fallback
download_iso() {
    local url="$1"
    local filename="$2"
    local iso_path="$VM_DIR/isos/$filename"

    if [ -f "$iso_path" ]; then
        print_status "info" "ISO already exists: $filename"
        echo "$iso_path"
        return 0
    fi

    print_status "info" "Downloading $filename..."

    # Try wget first
    if command -v wget >/dev/null 2>&1; then
        if wget --progress=bar:force -O "$iso_path" "$url" 2>&1; then
            print_status "success" "Downloaded $filename"
            echo "$iso_path"
            return 0
        fi
    fi

    # Fallback to curl
    if command -v curl >/dev/null 2>&1; then
        if curl -L --progress-bar -o "$iso_path" "$url" 2>&1; then
            print_status "success" "Downloaded $filename"
            echo "$iso_path"
            return 0
        fi
    fi

    print_status "error" "Failed to download $filename"
    rm -f "$iso_path"
    return 1
}

# List all VMs and containers
list_vms() {
    print_header "Virtual Machines & Containers"

    # Multipass VMs
    if command -v multipass >/dev/null 2>&1; then
        echo -e "${CYAN}${BOLD}Multipass VMs:${NC}"
        echo -e "${GRAY}────────────────────────────────────────────────────────────${NC}"

        local vms=$(multipass list --format csv | tail -n +2)
        if [ -n "$vms" ]; then
            echo -e "${WHITE}Name${NC}    ${WHITE}State${NC}     ${WHITE}IPv4${NC}           ${WHITE}CPUs${NC}  ${WHITE}Memory${NC}  ${WHITE}Disk${NC}"
            echo -e "${GRAY}────    ──────     ────           ────${NC}  ${GRAY}──────${NC}  ${GRAY}────${NC}"
            echo "$vms" | while IFS=',' read -r name state ipv4 cpus memory disk; do
                printf "%-8s %-11s %-15s %-5s %-8s %-6s\n" "$name" "$state" "$ipv4" "$cpus" "$memory" "$disk"
            done
        else
            echo -e "${GRAY}No Multipass VMs found${NC}"
        fi
        echo ""
    fi

    # VirtualBox VMs
    if command -v VBoxManage >/dev/null 2>&1; then
        echo -e "${CYAN}${BOLD}VirtualBox VMs:${NC}"
        echo -e "${GRAY}────────────────────────────────────────────────────────────${NC}"

        local vms=$(VBoxManage list vms 2>/dev/null)
        if [ -n "$vms" ]; then
            echo "$vms" | while read -r line; do
                local vm_name=$(echo "$line" | sed 's/"\([^"]*\)".*/\1/')
                local state=$(VBoxManage showvminfo "$vm_name" --machinereadable | grep "VMState=" | cut -d'=' -f2 | tr -d '"')
                printf "${WHITE}%-30s${NC} ${GRAY}(${state})${NC}\n" "$vm_name"
            done
        else
            echo -e "${GRAY}No VirtualBox VMs found${NC}"
        fi
        echo ""
    fi

    # QEMU VMs
    if command -v qemu-system-x86_64 >/dev/null 2>&1; then
        echo -e "${CYAN}${BOLD}QEMU VMs:${NC}"
        echo -e "${GRAY}────────────────────────────────────────────────────────────${NC}"

        local qemus=$(find "$VM_DIR" -name "*.qcow2" -o -name "*.img" 2>/dev/null)
        if [ -n "$qemus" ]; then
            echo "$qemus" | while read -r img; do
                local basename=$(basename "$img")
                printf "${WHITE}%-30s${NC} ${GRAY}($(du -h "$img" | cut -f1))${NC}\n" "$basename"
            done
        else
            echo -e "${GRAY}No QEMU VMs found${NC}"
        fi
        echo ""
    fi

    # Docker Containers
    echo -e "${CYAN}${BOLD}Docker Containers:${NC}"
    echo -e "${GRAY}────────────────────────────────────────────────────────────${NC}"

    if command -v docker >/dev/null 2>&1; then
        local docker_containers=$(docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | tail -n +2)
        if [ -n "$docker_containers" ]; then
            echo -e "${WHITE}Name${NC}                    ${WHITE}Status${NC}                    ${WHITE}Ports${NC}"
            echo -e "${GRAY}────                    ──────                    ─────${NC}"
            echo "$docker_containers"
        else
            echo -e "${GRAY}No Docker containers found${NC}"
        fi
    else
        echo -e "${RED}Docker not installed${NC}"
    fi

    echo ""
    read -p "Press Enter to return to menu..."
}

# Create Multipass VM
create_multipass_vm() {
    print_header "Create Multipass VM"
    print_box "Multipass VM Configuration" "$MAGENTA"
    echo

    # Get VM name
    local default_name="vm-$(date +%Y%m%d-%H%M%S)"
    echo -e "${WHITE}VM Name [${GRAY}$default_name${NC}${WHITE}]:${NC} "
    read -r vm_name
    vm_name=${vm_name:-$default_name}

    # Select OS
    echo
    echo -e "${WHITE}Select OS:${NC}"
    echo "1) Ubuntu 22.04 LTS (default)"
    echo "2) Ubuntu 20.04 LTS"
    echo "3) Ubuntu 18.04 LTS"
    echo "4) Custom image"
    echo -e "${WHITE}Choice [${GRAY}1${NC}${WHITE}]:${NC} "
    read -r os_choice

    local os_image="jammy"
    case "$os_choice" in
        "2") os_image="focal" ;;
        "3") os_image="bionic" ;;
        "4")
            echo -e "${WHITE}Enter image name:${NC} "
            read -r custom_image
            os_image="$custom_image"
            ;;
    esac

    # Configuration
    echo -e "${WHITE}CPU cores [${GRAY}2${NC}${WHITE}]:${NC} "
    read -r cpus
    cpus=${cpus:-2}

    echo -e "${WHITE}Memory (GB) [${GRAY}4${NC}${WHITE}]:${NC} "
    read -r memory_gb
    memory_gb=${memory_gb:-4}

    echo -e "${WHITE}Disk (GB) [${GRAY}20${NC}${WHITE}]:${NC} "
    read -r disk_gb
    disk_gb=${disk_gb:-20}

    # Create VM
    echo
    print_status "info" "Creating Multipass VM: $vm_name"

    if multipass launch "$os_image" \
        --name "$vm_name" \
        --cpus "$cpus" \
        --memory "${memory_gb}G" \
        --disk "${disk_gb}G" \
        --timeout 300; then

        print_status "success" "VM created successfully!"

        # Get IP
        local vm_ip=$(multipass info "$vm_name" --format csv | tail -n +2 | cut -d',' -f3)
        print_status "info" "VM IP: $vm_ip"

        # Show connection info
        echo
        print_status "info" "Connect with: multipass shell $vm_name"
        print_status "info" "Transfer files: multipass transfer"
    else
        print_status "error" "Failed to create VM"
    fi

    echo ""
    read -p "Press Enter to continue..."
}

# Create Docker container
create_docker_container() {
    print_header "Create Docker Container"
    print_box "Docker Container Configuration" "$MAGENTA"
    echo

    # Get container name
    local default_name="container-$(date +%Y%m%d-%H%M%S)"
    echo -e "${WHITE}Container Name [${GRAY}$default_name${NC}${WHITE}]:${NC} "
    read -r container_name
    container_name=${container_name:-$default_name}

    # Select image
    echo
    echo -e "${WHITE}Select base image:${NC}"
    echo "1) ubuntu:latest (default)"
    echo "2) alpine:latest"
    echo "3) debian:latest"
    echo "4) Custom image"
    echo -e "${WHITE}Choice [${GRAY}1${NC}${WHITE}]:${NC} "
    read -r image_choice

    local base_image="ubuntu:latest"
    case "$image_choice" in
        "2") base_image="alpine:latest" ;;
        "3") base_image="debian:latest" ;;
        "4")
            echo -e "${WHITE}Enter image name:${NC} "
            read -r custom_image
            base_image="$custom_image"
            ;;
    esac

    # Configuration
    echo -e "${WHITE}Keep container running after creation? [${GRAY}y/N${NC}${WHITE}]:${NC} "
    read -r keep_running

    # Create container
    echo
    print_status "info" "Creating Docker container: $container_name"

    if docker create --name "$container_name" "$base_image" tail -f /dev/null; then
        print_status "success" "Container created successfully!"

        if [[ "$keep_running" =~ ^[Yy]$ ]]; then
            docker start "$container_name"
            print_status "info" "Container started"
        fi

        # Show connection info
        echo
        print_status "info" "Connect with: docker exec -it $container_name /bin/bash"
        print_status "info" "Start with: docker start $container_name"
    else
        print_status "error" "Failed to create container"
    fi

    echo ""
    read -p "Press Enter to continue..."
}

# Create VirtualBox VM
create_virtualbox_vm() {
    print_header "Create VirtualBox VM"
    print_box "VirtualBox VM Configuration" "$MAGENTA"
    echo

    # Get VM name
    local default_name="vm-$(date +%Y%m%d-%H%M%S)"
    echo -e "${WHITE}VM Name [${GRAY}$default_name${NC}${WHITE}]:${NC} "
    read -r vm_name
    vm_name=${vm_name:-$default_name}

    # OS type
    echo
    echo -e "${WHITE}Select OS type:${NC}"
    echo "1) Ubuntu 64-bit (default)"
    echo "2) Debian 64-bit"
    echo "3) Windows 10"
    echo "4) Custom"
    echo -e "${WHITE}Choice [${GRAY}1${NC}${WHITE}]:${NC} "
    read -r os_type

    local ostype="Ubuntu_64"
    case "$os_type" in
        "2") ostype="Debian_64" ;;
        "3") ostype="Windows10_64" ;;
        "4")
            echo -e "${WHITE}Enter OS type:${NC} "
            read -r custom_ostype
            ostype="$custom_ostype"
            ;;
    esac

    # Configuration
    echo -e "${WHITE}Memory (MB) [${GRAY}2048${NC}${WHITE}]:${NC} "
    read -r memory_mb
    memory_mb=${memory_mb:-2048}

    echo -e "${WHITE}CPU cores [${GRAY}2${NC}${WHITE}]:${NC} "
    read -r cpus
    cpus=${cpus:-2}

    echo -e "${WHITE}Disk size (GB) [${GRAY}20${NC}${WHITE}]:${NC} "
    read -r disk_gb
    disk_gb=${disk_gb:-20}

    # Create VM
    local vm_path="$VM_DIR/$vm_name"
    mkdir -p "$vm_path"

    echo
    print_status "info" "Creating VirtualBox VM: $vm_name"

    if VBoxManage createvm --name "$vm_name" --ostype "$ostype" --register --basefolder "$VM_DIR" && \
       VBoxManage modifyvm "$vm_name" --memory "$memory_mb" --cpus "$cpus" && \
       VBoxManage createhd --filename "$vm_path/$vm_name.vdi" --size $((disk_gb * 1024)) && \
       VBoxManage storagectl "$vm_name" --name "SATA Controller" --add sata && \
       VBoxManage storageattach "$vm_name" --storagectl "SATA Controller" --port 0 --device 0 --type hdd --medium "$vm_path/$vm_name.vdi"; then

        print_status "success" "VM created successfully!"
        print_status "info" "VM location: $vm_path"
        print_status "warning" "You need to attach an ISO and install the OS manually"
    else
        print_status "error" "Failed to create VM"
    fi

    echo ""
    read -p "Press Enter to continue..."
}

# Create QEMU VM
create_qemu_vm() {
    print_header "Create QEMU VM"
    print_box "QEMU VM Configuration" "$MAGENTA"
    echo

    # Get VM name
    local default_name="vm-$(date +%Y%m%d-%H%M%S)"
    echo -e "${WHITE}VM Name [${GRAY}$default_name${NC}${WHITE}]:${NC} "
    read -r vm_name
    vm_name=${vm_name:-$default_name}

    # Disk size
    echo -e "${WHITE}Disk size (GB) [${GRAY}20${NC}${WHITE}]:${NC} "
    read -r disk_gb
    disk_gb=${disk_gb:-20}

    # Memory
    echo -e "${WHITE}Memory (MB) [${GRAY}2048${NC}${WHITE}]:${NC} "
    read -r memory_mb
    memory_mb=${memory_mb:-2048}

    # CPU cores
    echo -e "${WHITE}CPU cores [${GRAY}2${NC}${WHITE}]:${NC} "
    read -r cpus
    cpus=${cpus:-2}

    # Create VM
    local vm_path="$VM_DIR/$vm_name"
    mkdir -p "$vm_path"
    local disk_path="$vm_path/disk.qcow2"

    echo
    print_status "info" "Creating QEMU VM: $vm_name"

    # Create disk
    if qemu-img create -f qcow2 "$disk_path" "${disk_gb}G"; then
        print_status "success" "Disk created: $disk_path"

        # Show start command
        echo
        print_status "info" "To start the VM, use:"
        echo -e "${CYAN}qemu-system-x86_64 -m ${memory_mb} -smp ${cpus} -hda ${disk_path} -boot d${NC}"
        echo
        print_status "warning" "You need to provide an ISO file to install the OS"
        print_status "info" "ISO files should be placed in: $VM_DIR/isos/"

        # List available ISOs
        if ls "$VM_DIR/isos"/*.iso >/dev/null 2>&1; then
            echo
            print_status "info" "Available ISO files:"
            ls -la "$VM_DIR/isos"/*.iso | while read -r line; do
                local iso_name=$(basename "$line" | awk '{print $9}')
                echo -e "  ${GREEN}•${NC} $iso_name"
            done
        fi
    else
        print_status "error" "Failed to create disk"
    fi

    echo ""
    read -p "Press Enter to continue..."
}

# Launch VM or container
launch_vm() {
    print_header "Launch VM or Container"

    echo -e "${WHITE}Select type:${NC}"
    echo "1) Multipass VM"
    echo "2) VirtualBox VM"
    echo "3) QEMU VM"
    echo "4) Docker Container"
    echo -e "${WHITE}Choice [${GRAY}1${NC}${WHITE}]:${NC} "
    read -r vm_type

    case "$vm_type" in
        "2")
            echo ""
            echo -e "${CYAN}${BOLD}Available VirtualBox VMs:${NC}"
            echo -e "${GRAY}────────────────────────────────────────${NC}"
            local vms=$(VBoxManage list vms 2>/dev/null | sed 's/"//g' | awk '{print $1}')
            if [ -n "$vms" ]; then
                local i=1
                echo "$vms" | while read -r vm; do
                    echo "  $i) $vm"
                    i=$((i+1))
                done
                echo -e "${WHITE}Select VM:${NC} "
                read -r vm_choice

                local selected_vm=$(echo "$vms" | sed -n "${vm_choice}p")
                if [ -n "$selected_vm" ]; then
                    VBoxManage startvm "$selected_vm" --type gui
                    print_status "success" "Starting $selected_vm"
                fi
            else
                print_status "warning" "No VirtualBox VMs found"
            fi
            ;;
        "4")
            echo ""
            echo -e "${CYAN}${BOLD}Available Docker Containers:${NC}"
            echo -e "${GRAY}────────────────────────────────────────${NC}"
            local containers=$(docker ps -a --format "{{.Names}}" 2>/dev/null)
            if [ -n "$containers" ]; then
                local i=1
                echo "$containers" | while read -r container; do
                    echo "  $i) $container"
                    i=$((i+1))
                done
                echo -e "${WHITE}Select container:${NC} "
                read -r container_choice

                local selected_container=$(echo "$containers" | sed -n "${container_choice}p")
                if [ -n "$selected_container" ]; then
                    docker start "$selected_container" >/dev/null 2>&1
                    print_status "success" "Connecting to $selected_container"
                    docker exec -it "$selected_container" /bin/bash || docker exec -it "$selected_container" /bin/sh
                fi
            else
                print_status "warning" "No Docker containers found"
            fi
            ;;
        *)
            echo ""
            echo -e "${CYAN}${BOLD}Available Multipass VMs:${NC}"
            echo -e "${GRAY}────────────────────────────────────────${NC}"
            local vms=$(multipass list --format csv | tail -n +2 | cut -d',' -f1)
            if [ -n "$vms" ]; then
                local i=1
                echo "$vms" | while read -r vm; do
                    echo "  $i) $vm"
                    i=$((i+1))
                done
                echo -e "${WHITE}Select VM:${NC} "
                read -r vm_choice

                local selected_vm=$(echo "$vms" | sed -n "${vm_choice}p")
                if [ -n "$selected_vm" ]; then
                    print_status "success" "Connecting to $selected_vm"
                    multipass shell "$selected_vm"
                fi
            else
                print_status "warning" "No Multipass VMs found"
            fi
            ;;
    esac

    echo ""
    read -p "Press Enter to return to menu..."
}

# Delete VM or container
delete_vm() {
    print_header "Delete VM or Container"

    echo -e "${WHITE}Select type:${NC}"
    echo "1) Multipass VM"
    echo "2) VirtualBox VM"
    echo "3) QEMU VM"
    echo "4) Docker Container"
    echo -e "${WHITE}Choice [${GRAY}1${NC}${WHITE}]:${NC} "
    read -r vm_type

    case "$vm_type" in
        "4")
            echo ""
            echo -e "${CYAN}${BOLD}Available Docker Containers:${NC}"
            echo -e "${GRAY}────────────────────────────────────────${NC}"
            local containers=$(docker ps -a --format "{{.Names}}" 2>/dev/null)
            if [ -n "$containers" ]; then
                local i=1
                echo "$containers" | while read -r container; do
                    echo "  $i) $container"
                    i=$((i+1))
                done
                echo -e "${WHITE}Select container to delete:${NC} "
                read -r container_choice

                local selected_container=$(echo "$containers" | sed -n "${container_choice}p")
                if [ -n "$selected_container" ]; then
                    echo -e "${RED}Delete container '$selected_container'? [y/N]:${NC} "
                    read -r confirm
                    if [[ "$confirm" =~ ^[Yy]$ ]]; then
                        docker rm "$selected_container"
                        print_status "success" "Container deleted"
                    fi
                fi
            else
                print_status "warning" "No Docker containers found"
            fi
            ;;
        *)
            echo ""
            echo -e "${CYAN}${BOLD}Available Multipass VMs:${NC}"
            echo -e "${GRAY}────────────────────────────────────────${NC}"
            local vms=$(multipass list --format csv | tail -n +2 | cut -d',' -f1)
            if [ -n "$vms" ]; then
                local i=1
                echo "$vms" | while read -r vm; do
                    echo "  $i) $vm"
                    i=$((i+1))
                done
                echo -e "${WHITE}Select VM to delete:${NC} "
                read -r vm_choice

                local selected_vm=$(echo "$vms" | sed -n "${vm_choice}p")
                if [ -n "$selected_vm" ]; then
                    echo -e "${RED}Delete VM '$selected_vm'? [y/N]:${NC} "
                    read -r confirm
                    if [[ "$confirm" =~ ^[Yy]$ ]]; then
                        multipass delete "$selected_vm" && multipass purge
                        print_status "success" "VM deleted"
                    fi
                fi
            else
                print_status "warning" "No Multipass VMs found"
            fi
            ;;
    esac

    echo ""
    read -p "Press Enter to return to menu..."
}

# VM operations (start, stop, restart, etc.)
vm_operations() {
    print_header "VM Operations"

    echo -e "${WHITE}Select operation:${NC}"
    echo "1) Start VM"
    echo "2) Stop VM"
    echo "3) Restart VM"
    echo "4) Suspend VM"
    echo "5) Resume VM"
    echo -e "${WHITE}Choice [${GRAY}1${NC}${WHITE}]:${NC} "
    read -r operation

    local operation_name=""
    case "$operation" in
        "1") operation_name="start" ;;
        "2") operation_name="stop" ;;
        "3") operation_name="restart" ;;
        "4") operation_name="suspend" ;;
        "5") operation_name="resume" ;;
        *) operation_name="start" ;;
    esac

    echo ""
    echo -e "${CYAN}${BOLD}Available Multipass VMs:${NC}"
    local vms=$(multipass list --format csv | tail -n +2 | cut -d',' -f1)
    if [ -n "$vms" ]; then
        local i=1
        echo "$vms" | while read -r vm; do
            echo "  $i) $vm"
            i=$((i+1))
        done
        echo -e "${WHITE}Select VM:${NC} "
        read -r vm_choice

        local selected_vm=$(echo "$vms" | sed -n "${vm_choice}p")
        if [ -n "$selected_vm" ]; then
            if multipass "$operation_name" "$selected_vm"; then
                print_status "success" "VM $operation_name completed"
            else
                print_status "error" "Failed to $operation_name VM"
            fi
        fi
    else
        print_status "warning" "No Multipass VMs found"
    fi

    echo ""
    read -p "Press Enter to return to menu..."
}

# Settings menu
settings_menu() {
    while true; do
        print_header "Settings"

        print_menu_item "1" "Install Dependencies" "Install Multipass and Docker" "$GREEN"
        print_menu_item "2" "Clean Up" "Remove stopped containers and deleted VMs" "$YELLOW"
        print_menu_item "3" "View Logs" "Show VM operation logs" "$BLUE"
        print_menu_item "4" "Reset Configuration" "Reset VM Manager settings" "$RED"
        echo ""
        print_menu_item "5" "Back to Main Menu" "" "$GRAY"

        echo -e "${WHITE}Choice [${GRAY}5${NC}${WHITE}]:${NC} "
        read -r choice

        case "$choice" in
            "1") install_dependencies ;;
            "2") cleanup_vms ;;
            "3") view_logs ;;
            "4") reset_config ;;
            "5"|"") break ;;
            *) print_status "error" "Invalid choice" ;;
        esac
    done
}

# Install dependencies
install_dependencies() {
    print_header "Install Dependencies"

    # Install Multipass
    if ! command -v multipass >/dev/null 2>&1; then
        print_status "info" "Installing Multipass..."
        if sudo snap install multipass; then
            print_status "success" "Multipass installed"
        else
            print_status "error" "Failed to install Multipass"
        fi
    else
        print_status "success" "Multipass already installed"
    fi

    # Install Docker
    if ! command -v docker >/dev/null 2>&1; then
        print_status "info" "Installing Docker..."
        if sudo apt update && sudo apt install -y docker.io; then
            print_status "success" "Docker installed"
            # Add user to docker group
            sudo usermod -aG docker "$USER"
            print_status "info" "Added user to docker group (log out/in to apply)"
        else
            print_status "error" "Failed to install Docker"
        fi
    else
        print_status "success" "Docker already installed"
    fi

    echo ""
    read -p "Press Enter to return to menu..."
}

# Clean up VMs and containers
cleanup_vms() {
    print_header "Clean Up"

    echo "This will remove:"
    echo "• All stopped Docker containers"
    echo "• All deleted Multipass VMs (purge)"
    echo "• Unused Docker images"
    echo ""
    echo -e "${RED}Are you sure? [y/N]:${NC} "
    read -r confirm

    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        print_status "info" "Cleaning up Docker containers..."
        docker container prune -f >/dev/null 2>&1

        print_status "info" "Purging Multipass VMs..."
        multipass purge >/dev/null 2>&1

        print_status "info" "Cleaning up Docker images..."
        docker image prune -f >/dev/null 2>&1

        print_status "success" "Cleanup completed"
    else
        print_status "info" "Cleanup cancelled"
    fi

    echo ""
    read -p "Press Enter to return to menu..."
}

# View logs
view_logs() {
    print_header "VM Operation Logs"

    echo -e "${WHITE}Multipass logs:${NC}"
    multipass list --format csv | tail -10
    echo ""

    if command -v docker >/dev/null 2>&1; then
        echo -e "${WHITE}Docker:${NC}"
        docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.CreatedAt}}" | tail -10
        echo ""
    fi

    read -p "Press Enter to return to menu..."
}

# Reset configuration
reset_config() {
    print_header "Reset Configuration"

    echo -e "${RED}This will reset all VM Manager settings and preferences.${NC}"
    echo -e "${RED}Are you sure? [y/N]:${NC} "
    read -r confirm

    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        rm -rf "$VM_CONFIG_DIR"
        mkdir -p "$VM_CONFIG_DIR"
        print_status "success" "Configuration reset"
    else
        print_status "info" "Reset cancelled"
    fi

    echo ""
    read -p "Press Enter to return to menu..."
}

# Show help
show_help() {
    print_header "VM Manager Help"

    echo -e "${WHITE}VM Manager provides a unified interface for managing:${NC}"
    echo ""
    echo -e "${CYAN}${BOLD}Supported Platforms:${NC}"
    echo -e "${BLUE}• Multipass VMs${NC} - Lightweight Ubuntu VMs"
    echo -e "  - Quick to create and manage"
    echo -e "  - Automatic networking and IP assignment"
    echo -e "  - Good for development and testing"
    echo ""
    echo -e "${BLUE}• VirtualBox VMs${NC} - Full virtualization"
    echo -e "  - Complete OS support"
    echo -e "  - Snapshot support"
    echo -e "  - GUI access available"
    echo ""
    echo -e "${BLUE}• QEMU VMs${NC} - KVM-based virtualization"
    echo -e "  - High performance"
    echo -e "  - Native Linux virtualization"
    echo -e "  - Advanced configuration options"
    echo ""
    echo -e "${BLUE}• Docker Containers${NC} - Lightweight containers"
    echo -e "  - Use for quick testing"
    echo -e "  - Minimal resource usage"
    echo -e "  - Ephemeral by default"
    echo ""

    echo -e "${WHITE}Usage Tips:${NC}"
    echo -e "• Use Multipass VMs for quick experiments"
    echo -e "• Use VirtualBox for persistent development environments"
    echo -e "• Use Docker containers for application testing"
    echo -e "• VM configurations are saved in ~/.config/vm-manager/"
    echo -e "• All VMs are stored in ~/vms/"
    echo ""

    read -p "Press Enter to return to menu..."
}

# Main menu
main_menu() {
    while true; do
        # Get counts
        local multipass_count=0
        local docker_count=0

        if command -v multipass >/dev/null 2>&1; then
            multipass_count=$(multipass list --format csv 2>/dev/null | tail -n +2 | wc -l)
        fi

        if command -v docker >/dev/null 2>&1; then
            docker_count=$(docker ps -a --format "{{.Names}}" 2>/dev/null | wc -l)
        fi

        clear
        print_header "VM Manager"

        if [ $multipass_count -gt 0 ] || [ $docker_count -gt 0 ]; then
            echo -e "${GRAY}Quick Status: ${GREEN}$multipass_count${NC} Multipass VMs, ${GREEN}$docker_count${NC} Docker containers"
            echo ""
        fi

        print_box "Main Menu" "$MAGENTA"
        echo ""

        print_menu_item "1" "List All VMs & Containers" "Show all virtual machines and containers" "$BLUE"
        print_menu_item "2" "Create Multipass VM" "Create new Ubuntu VM" "$GREEN"
        print_menu_item "3" "Create VirtualBox VM" "Create full virtualization VM" "$GREEN"
        print_menu_item "4" "Create QEMU VM" "Create KVM-based VM" "$GREEN"
        print_menu_item "5" "Create Container" "Create new Docker container" "$GREEN"
        print_menu_item "6" "Launch VM" "Connect to existing VM or container" "$BLUE"
        print_menu_item "7" "Delete VM" "Remove VM or container" "$RED"
        print_menu_item "8" "VM Operations" "Start, stop, restart, suspend VMs" "$YELLOW"
        print_menu_item "9" "Settings" "Configure VM Manager" "$MAGENTA"
        echo ""
        print_menu_item "h" "Help" "Show usage information" "$CYAN"
        print_menu_item "q" "Quit" "Exit VM Manager" "$GRAY"

        echo ""
        echo -e "${WHITE}Choice [${GRAY}1${NC}${WHITE}]:${NC} "
        read -r choice

        case "$choice" in
            "1") list_vms ;;
            "2") create_multipass_vm ;;
            "3") create_virtualbox_vm ;;
            "4") create_qemu_vm ;;
            "5") create_docker_container ;;
            "6") launch_vm ;;
            "7") delete_vm ;;
            "8") vm_operations ;;
            "9") settings_menu ;;
            "h"|"help") show_help ;;
            "q"|"quit"|"exit") break ;;
            "1"|"") list_vms ;;
            *) print_status "error" "Invalid choice: $choice"; sleep 1 ;;
        esac
    done
}

# Main function
main() {
    # Check if script is sourced or run directly
    if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
        # Check dependencies
        if ! check_dependencies; then
            echo -e "${YELLOW}Some dependencies are missing, but you can still use the VM Manager.${NC}"
            echo -e "${YELLOW}Run 'vm settings' to install missing dependencies.${NC}"
            echo ""
            read -p "Press Enter to continue..."
        fi

        # Run main menu
        main_menu

        clear
        echo -e "${GREEN}Thank you for using VM Manager!${NC}"
    else
        # If sourced, just export functions
        echo "VM Manager functions loaded. Run 'vm' to start the interactive menu."
    fi
}

# Run main function if script is executed directly
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    main "$@"
fi