#!/usr/bin/env bash

# Plugin: secrets-sync
# Description: Secure environment variable synchronization
# Author: remcostoeten
# Date: 2025-09-01

# Ensure required functions are available
if ! declare -f echo.debug >/dev/null 2>&1; then
    source "${DOTFILES_ROOT:-$HOME/.config/dotfiles}/core/_colors" 2>/dev/null || {
        function echo.debug() { [[ "${DOTFILES_DEBUG}" == "1" ]] && echo "[DEBUG] $*" >&2; }
        function echo.error() { echo "[ERROR] $*" >&2; }
        function echo.success() { echo "[SUCCESS] $*"; }
        function echo.warning() { echo "[WARNING] $*" >&2; }
        function echo.info() { echo "[INFO] $*"; }
    }
fi

function install_secrets_sync() {
    echo.info "Installing secrets-sync plugin..."
    
    # Check if required dependencies are available
    local missing_deps=()
    
    # Check for essential tools
    command -v jq >/dev/null 2>&1 || missing_deps+=("jq")
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        echo.warning "Missing dependencies: ${missing_deps[*]}"
        echo.info "Install with: sudo apt update && sudo apt install ${missing_deps[*]}"
        return 1
    fi
    
    echo.success "Dependencies satisfied"
    return 0
}

function configure_secrets_sync() {
    echo.debug "Configuring secrets-sync plugin..."
    
    # Ensure secrets directory exists
    local secrets_dir="${DOTFILES_ROOT:-$HOME/.config/dotfiles}/utils/secrets"
    [[ ! -d "$secrets_dir" ]] && mkdir -p "$secrets_dir"
    
    # Set proper permissions on secrets directory
    chmod 700 "$secrets_dir" 2>/dev/null
    
    echo.debug "Secrets directory configured at $secrets_dir"
    return 0
}

function load_secrets_sync() {
    # Only load if explicitly enabled (auto_enable: false in config)
    if [[ "$DOTFILES_LOAD_SECRETS_SYNC" == "1" ]]; then
        echo.debug "Loading secrets-sync plugin..."
        
        configure_secrets_sync
        
        # Add any runtime setup here
        
        echo.debug "Secrets-sync plugin loaded"
    else
        echo.debug "Secrets-sync plugin available but not auto-loaded"
    fi
}

function secrets_sync_help() {
    echo.header "Secrets Sync Plugin Help"
    echo "Manages secure environment variable synchronization"
    echo ""
    echo "Usage:"
    echo "  This plugin provides secure storage for sensitive environment variables"
    echo "  and synchronization across different environments."
    echo ""
    echo "Configuration:"
    echo "  Set DOTFILES_LOAD_SECRETS_SYNC=1 to auto-load this plugin"
    echo "  Secrets are stored in: \$DOTFILES_ROOT/utils/secrets/"
    echo ""
    echo "Security:"
    echo "  - Secrets directory has 700 permissions (owner read/write/execute only)"
    echo "  - Files should never be committed to version control"
    echo "  - Use .gitignore to exclude secrets from git"
}

# Make help available as command
alias secrets-sync-help='secrets_sync_help'

# Install and configure if not already done
if ! declare -f secrets_sync_configured >/dev/null 2>&1; then
    if install_secrets_sync; then
        configure_secrets_sync
        
        # Mark as configured to avoid repeated setup
        function secrets_sync_configured() { return 0; }
        
        echo.debug "Secrets-sync plugin initialized"
    fi
fi

# Load the plugin
load_secrets_sync
